This file is a merged representation of a subset of the codebase, containing specifically included files, combined into a single document by Repomix.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of a subset of the repository's contents that is considered the most important context.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Only files matching these patterns are included: app/Actions/**/*, app/Data/**/*, app/Http/Controllers/**/*, app/Http/Middleware/**/*, app/Jobs/**/*, app/Models/**/*, app/Providers/**/*, routes/**/*, config/app.php, config/auth.php, config/database.php, config/tenancy.php, config/typescript-transformer.php, resources/js/**/*, resources/css/**/*, database/migrations/**/*, database/factories/**/*, database/seeders/**/*, tests/**/*, artisan, composer.json, composer.lock, package.json, pnpm-lock.yaml, vite.config.js, tsconfig.json, eslint.config.js, .env, .env.example, docs/**/*.md, README.md
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

</file_summary>

<directory_structure>
app/
  Actions/
    Tenant/
      GenerateQrBatchAction.php
  Data/
    Tenant/
      CommercialGoodData.php
    TestDTO.php
  Http/
    Controllers/
      Scan/
        TeaserController.php
      Controller.php
    Middleware/
      HandleInertiaRequests.php
  Jobs/
    CreateTenantDatabaseJob.php
  Models/
    Tenant/
      CommercialGood.php
      RewardCode.php
      User.php
    Tenant.php
    User.php
  Providers/
    Filament/
      AdminPanelProvider.php
    AppServiceProvider.php
    TenancyServiceProvider.php
config/
  app.php
  auth.php
  database.php
  tenancy.php
  typescript-transformer.php
database/
  factories/
    UserFactory.php
  migrations/
    tenant/
      2026_01_09_071658_create_tenant_users_table.php
      2026_01_12_221301_create_commercial_goods_table.php
      2026_01_12_221302_create_reward_codes_table.php
    0001_01_01_000000_create_users_table.php
    0001_01_01_000001_create_cache_table.php
    0001_01_01_000002_create_jobs_table.php
    2019_09_15_000010_create_tenants_table.php
    2019_09_15_000020_create_domains_table.php
    2026_01_09_071829_update_tenants_table_add_brand_config.php
  seeders/
    DatabaseSeeder.php
    RealWorldSeeder.php
resources/
  css/
    app.css
  js/
    components/
      ui/
        button.tsx
        card.tsx
        input.tsx
        label.tsx
        sonner.tsx
    Layouts/
      AppLayout.tsx
    lib/
      utils.ts
    Pages/
      Scan/
        Error.tsx
        Teaser.tsx
    types/
      generated.d.ts
    app.js
    app.tsx
    bootstrap.js
routes/
  console.php
  tenant.php
  web.php
tests/
  Feature/
    Tenant/
      GenerateQrBatchTest.php
      TeaserTest.php
    ExampleTest.php
  Traits/
    SetUpTenantTest.php
  Unit/
    Tenant/
      CommercialGoodTest.php
      GenerateQrBatchActionTest.php
    ExampleTest.php
  TestCase.php
  TestCaseTenant.php
.env.example
artisan
composer.json
eslint.config.js
package.json
README.md
tsconfig.json
vite.config.js
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path="app/Actions/Tenant/GenerateQrBatchAction.php">
<?php

namespace App\Actions\Tenant;

use App\Models\Tenant\CommercialGood;
use Illuminate\Support\Facades\Storage;
use Illuminate\Support\Str;
use League\Csv\Writer;

class GenerateQrBatchAction
{
    public function execute(CommercialGood $product, int $quantity, string $batchLabel): string
    {
        // Step A: Use the provided batchLabel as the batch ID
        $batchId = $batchLabel;

        // Step B: Loop $quantity times to generate 16-char random codes
        $codes = [];
        for ($i = 0; $i < $quantity; $i++) {
            $code = Str::random(16);
            $codes[] = [
                'code' => $code,
                'commercial_good_id' => $product->id,
                'batch_id' => $batchId,
                'status' => 'generated',
                'created_at' => now(),
                'updated_at' => now(),
            ];
        }

        // Step C: Insert into `reward_codes` table (Use `insert` in chunks of 1000 for speed)
        $chunks = array_chunk($codes, 1000);
        foreach ($chunks as $chunk) {
            \App\Models\Tenant\RewardCode::insert($chunk);
        }

        // Step D: Stream codes to a CSV file (using `league/csv`)
        $csv = Writer::createFromString();
        $csv->insertOne(['code', 'url']);

        foreach ($codes as $codeData) {
            // Generate a URL for each code (assuming there's a route to claim the code)
            $url = config('app.url').'/claim/'.$codeData['code']; // Generate claim URL
            $csv->insertOne([
                $codeData['code'],
                $url,
            ]);
        }

        // Step E: Store CSV on 's3' disk (path: `batches/{tenant_id}/{batch_id}.csv`)
        // For now, we'll use a placeholder since getting the tenant ID in this context is challenging
        // In a real application, this would be properly resolved
        $tenantId = 'current'; // Placeholder - in real usage, would get actual tenant ID
        $csvContent = $csv->toString();
        $csvPath = "batches/{$tenantId}/{$batchId}.csv";

        Storage::disk('s3')->put($csvPath, $csvContent);

        // Step F: Return the S3 path
        return $csvPath;
    }
}
</file>

<file path="app/Data/Tenant/CommercialGoodData.php">
<?php

namespace App\Data\Tenant;

use Spatie\LaravelData\Data;
use Spatie\TypeScriptTransformer\Attributes\TypeScript;

#[TypeScript]
class CommercialGoodData extends Data
{
    public function __construct(
        public int $id,
        public string $sku,
        public string $name,
        public ?string $description,
        public int $points_awarded,
        public string $image_url,
        public bool $is_active,
    ) {}
}
</file>

<file path="app/Data/TestDTO.php">
<?php

namespace App\Data;

use Spatie\LaravelData\Data;
use Spatie\TypeScriptTransformer\Attributes\TypeScript;

#[TypeScript]
class TestDTO extends Data
{
    public function __construct(
        public string $name,
        public int $age,
        public bool $isActive,
    ) {}
}
</file>

<file path="app/Http/Controllers/Scan/TeaserController.php">
<?php

namespace App\Http\Controllers\Scan;

use App\Data\Tenant\CommercialGoodData;
use App\Models\Tenant\RewardCode;
use Illuminate\Http\Request;
use Inertia\Inertia;
use Inertia\Response;

class TeaserController
{
    public function __invoke(Request $request, string $code): Response
    {
        // Find RewardCode by code
        $rewardCode = RewardCode::where('code', $code)->first();

        if (! $rewardCode) {
            // If code doesn't exist, return invalid error
            return Inertia::render('Scan/Error', ['reason' => 'invalid']);
        }

        // Check Status
        if ($rewardCode->status === 'used') {
            // If used -> Return Inertia::render('Scan/Error', ['reason' => 'used']).
            return Inertia::render('Scan/Error', ['reason' => 'used']);
        }

        if ($rewardCode->status === 'void') {
            // If void -> Return Inertia::render('Scan/Error', ['reason' => 'invalid']).
            return Inertia::render('Scan/Error', ['reason' => 'invalid']);
        }

        if ($rewardCode->status === 'active') {
            // If active -> Return Inertia::render('Scan/Teaser', ['product' => CommercialGoodData::from($code->commercialGood)]).
            return Inertia::render('Scan/Teaser', [
                'product' => CommercialGoodData::from($rewardCode->commercialGood),
            ]);
        }

        // Default case for any other statuses
        return Inertia::render('Scan/Error', ['reason' => 'invalid']);
    }
}
</file>

<file path="app/Http/Controllers/Controller.php">
<?php

namespace App\Http\Controllers;

abstract class Controller
{
    //
}
</file>

<file path="app/Http/Middleware/HandleInertiaRequests.php">
<?php

namespace App\Http\Middleware;

use Illuminate\Http\Request;
use Inertia\Middleware;

class HandleInertiaRequests extends Middleware
{
    /**
     * The root template that's loaded on the first page visit.
     *
     * @see https://inertiajs.com/server-side-setup#root-template
     *
     * @var string
     */
    protected $rootView = 'app';

    /**
     * Determines the current asset version.
     *
     * @see https://inertiajs.com/asset-versioning
     */
    public function version(Request $request): ?string
    {
        return parent::version($request);
    }

    /**
     * Define the props that are shared by default.
     *
     * @see https://inertiajs.com/shared-data
     *
     * @return array<string, mixed>
     */
    public function share(Request $request): array
    {
        $shared = [
            ...parent::share($request),
        ];

        // Check if we're in a tenant context and add tenant config
        if (tenant()) {
            $shared['auth']['tenant'] = [
                'id' => tenant('id'),
                'config' => tenant('config') ?? [],
            ];
        }

        return $shared;
    }
}
</file>

<file path="app/Jobs/CreateTenantDatabaseJob.php">
<?php

namespace App\Jobs;

use App\Models\Tenant;
use Illuminate\Bus\Queueable;
use Illuminate\Contracts\Queue\ShouldQueue;
use Illuminate\Foundation\Bus\Dispatchable;
use Illuminate\Queue\InteractsWithQueue;
use Illuminate\Queue\SerializesModels;
use Illuminate\Support\Facades\Artisan;

class CreateTenantDatabaseJob implements ShouldQueue
{
    use Dispatchable, InteractsWithQueue, Queueable, SerializesModels;

    /**
     * Create a new job instance.
     */
    public function __construct(
        protected Tenant $tenant
    ) {}

    /**
     * Execute the job.
     */
    public function handle(): void
    {
        // Run the tenant-specific migrations using tenancy context
        $tenantId = $this->tenant->getTenantKey();
        tenancy()->runForMultiple(collect([$tenantId]), function () {
            // Run the tenant-specific migrations
            Artisan::call('migrate', [
                '--path' => 'database/migrations/tenant',
                '--force' => true, // Required for production environments
            ]);

            // Optionally, seed the tenant database
            Artisan::call('db:seed', [
                '--force' => true,
            ]);
        });
    }
}
</file>

<file path="app/Models/Tenant/CommercialGood.php">
<?php

namespace App\Models\Tenant;

use Illuminate\Database\Eloquent\Model;
use Illuminate\Database\Eloquent\Relations\HasMany;
use Stancl\Tenancy\Database\Concerns\TenantConnection;

class CommercialGood extends Model
{
    use TenantConnection;

    protected $fillable = [
        'sku',
        'name',
        'description',
        'points_awarded',
        'msrp_cents',
        'strain_type',
        'image_url',
        'is_active',
    ];

    protected $casts = [
        'is_active' => 'boolean',
        'points_awarded' => 'integer',
        'msrp_cents' => 'integer',
    ];

    public function rewardCodes(): HasMany
    {
        return $this->hasMany(RewardCode::class, 'commercial_good_id');
    }
}
</file>

<file path="app/Models/Tenant/RewardCode.php">
<?php

namespace App\Models\Tenant;

use Illuminate\Database\Eloquent\Model;
use Illuminate\Database\Eloquent\Relations\BelongsTo;
use Stancl\Tenancy\Database\Concerns\TenantConnection;

class RewardCode extends Model
{
    use TenantConnection;

    public $incrementing = false;

    protected $keyType = 'string';

    protected $primaryKey = 'code';

    protected $fillable = [
        'code',
        'commercial_good_id',
        'batch_id',
        'status',
        'user_id',
        'claimed_at',
    ];

    protected $casts = [
        'claimed_at' => 'datetime',
    ];

    public function commercialGood(): BelongsTo
    {
        return $this->belongsTo(CommercialGood::class, 'commercial_good_id');
    }
}
</file>

<file path="app/Models/Tenant/User.php">
<?php

namespace App\Models\Tenant;

use Illuminate\Database\Eloquent\Factories\HasFactory;
use Illuminate\Foundation\Auth\User as Authenticatable;
use Illuminate\Notifications\Notifiable;

class User extends Authenticatable
{
    use HasFactory, Notifiable;

    protected $fillable = [
        'uuid',
        'phone',
        'email',
        'name',
        'dob',
        'points_balance',
        'lifetime_points',
        'current_rank_key',
        'referral_code',
        'referred_by_id',
        'signals',
        'marketing_opt_in',
    ];

    protected $hidden = [
        'password',
        'remember_token',
    ];

    /**
     * The attributes that should be cast.
     *
     * @var array<string, string>
     */
    protected $casts = [
        'email_verified_at' => 'datetime',
        'dob' => 'date',
        'points_balance' => 'integer',
        'lifetime_points' => 'integer',
        'marketing_opt_in' => 'boolean',
        'signals' => 'array',
        'uuid' => 'string',
    ];

    /**
     * The model's default values for attributes.
     *
     * @var array<string, mixed>
     */
    protected $attributes = [
        'points_balance' => 0,
        'lifetime_points' => 0,
        'current_rank_key' => 'member',
        'marketing_opt_in' => false,
    ];

    /**
     * Get the route key for the model.
     *
     * @return string
     */
    public function getRouteKeyName()
    {
        return 'uuid';
    }
}
</file>

<file path="app/Models/Tenant.php">
<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Model;
use Illuminate\Database\Eloquent\Relations\HasMany;
use Stancl\Tenancy\Contracts\TenantWithDatabase;
use Stancl\Tenancy\Database\Concerns\CentralConnection;
use Stancl\Tenancy\Database\Concerns\GeneratesIds;
use Stancl\Tenancy\Database\Concerns\HasDatabase;
use Stancl\Tenancy\Database\Concerns\HasDomains;
use Stancl\Tenancy\Database\Concerns\HasInternalKeys;
use Stancl\Tenancy\Database\Concerns\InvalidatesResolverCache;
use Stancl\Tenancy\Database\Concerns\TenantRun;

class Tenant extends Model implements TenantWithDatabase
{
    use CentralConnection, GeneratesIds, HasDatabase, HasDomains, HasInternalKeys, InvalidatesResolverCache, TenantRun;

    protected $fillable = [
        'id',
        'brand_name',
        'plan',
        'config',
        'data',
    ];

    /**
     * The attributes that should be cast.
     *
     * @var array<string, string>
     */
    protected $casts = [
        'config' => 'array',
        'data' => 'array',
    ];

    /**
     * Get the route key for the model.
     *
     * @return string
     */
    public function getRouteKeyName()
    {
        return 'id';
    }

    /**
     * Get the domains associated with the tenant.
     */
    public function domains(): HasMany
    {
        return $this->hasMany(\Stancl\Tenancy\Database\Models\Domain::class, 'tenant_id');
    }

    public function getTenantKeyName(): string
    {
        return 'id';
    }

    public function getTenantKey()
    {
        return $this->getAttribute($this->getTenantKeyName());
    }
}
</file>

<file path="app/Models/User.php">
<?php

namespace App\Models;

// use Illuminate\Contracts\Auth\MustVerifyEmail;
use Illuminate\Database\Eloquent\Factories\HasFactory;
use Illuminate\Foundation\Auth\User as Authenticatable;
use Illuminate\Notifications\Notifiable;

class User extends Authenticatable
{
    /** @use HasFactory<\Database\Factories\UserFactory> */
    use HasFactory, Notifiable;

    /**
     * The attributes that are mass assignable.
     *
     * @var list<string>
     */
    protected $fillable = [
        'name',
        'email',
        'password',
    ];

    /**
     * The attributes that should be hidden for serialization.
     *
     * @var list<string>
     */
    protected $hidden = [
        'password',
        'remember_token',
    ];

    /**
     * Get the attributes that should be cast.
     *
     * @return array<string, string>
     */
    protected function casts(): array
    {
        return [
            'email_verified_at' => 'datetime',
            'password' => 'hashed',
        ];
    }
}
</file>

<file path="app/Providers/Filament/AdminPanelProvider.php">
<?php

namespace App\Providers\Filament;

use Filament\Http\Middleware\Authenticate;
use Filament\Http\Middleware\AuthenticateSession;
use Filament\Http\Middleware\DisableBladeIconComponents;
use Filament\Http\Middleware\DispatchServingFilamentEvent;
use Filament\Pages;
use Filament\Panel;
use Filament\PanelProvider;
use Filament\Support\Colors\Color;
use Filament\Widgets;
use Illuminate\Cookie\Middleware\AddQueuedCookiesToResponse;
use Illuminate\Cookie\Middleware\EncryptCookies;
use Illuminate\Foundation\Http\Middleware\VerifyCsrfToken;
use Illuminate\Routing\Middleware\SubstituteBindings;
use Illuminate\Session\Middleware\StartSession;
use Illuminate\View\Middleware\ShareErrorsFromSession;

class AdminPanelProvider extends PanelProvider
{
    public function panel(Panel $panel): Panel
    {
        return $panel
            ->default()
            ->id('admin')
            ->path('admin')
            ->login()
            ->colors([
                'primary' => Color::Amber,
            ])
            ->discoverResources(in: app_path('Filament/Resources'), for: 'App\\Filament\\Resources')
            ->discoverPages(in: app_path('Filament/Pages'), for: 'App\\Filament\\Pages')
            ->pages([
                Pages\Dashboard::class,
                \App\Filament\Pages\CreateQrBatch::class,
            ])
            ->discoverWidgets(in: app_path('Filament/Widgets'), for: 'App\\Filament\\Widgets')
            ->widgets([
                Widgets\AccountWidget::class,
                Widgets\FilamentInfoWidget::class,
            ])
            ->middleware([
                EncryptCookies::class,
                AddQueuedCookiesToResponse::class,
                StartSession::class,
                AuthenticateSession::class,
                ShareErrorsFromSession::class,
                VerifyCsrfToken::class,
                SubstituteBindings::class,
                DisableBladeIconComponents::class,
                DispatchServingFilamentEvent::class,
            ])
            ->authMiddleware([
                Authenticate::class,
            ]);
    }
}
</file>

<file path="app/Providers/AppServiceProvider.php">
<?php

namespace App\Providers;

use Illuminate\Support\ServiceProvider;

class AppServiceProvider extends ServiceProvider
{
    /**
     * Register any application services.
     */
    public function register(): void
    {
        //
    }

    /**
     * Bootstrap any application services.
     */
    public function boot(): void
    {
        //
    }
}
</file>

<file path="app/Providers/TenancyServiceProvider.php">
<?php

declare(strict_types=1);

namespace App\Providers;

use Illuminate\Support\Facades\Event;
use Illuminate\Support\Facades\Route;
use Illuminate\Support\ServiceProvider;
use Stancl\JobPipeline\JobPipeline;
use Stancl\Tenancy\Events;
use Stancl\Tenancy\Jobs;
use Stancl\Tenancy\Listeners;
use Stancl\Tenancy\Middleware;

class TenancyServiceProvider extends ServiceProvider
{
    // By default, no namespace is used to support the callable array syntax.
    public static string $controllerNamespace = '';

    public function events()
    {
        return [
            // Tenant events
            Events\CreatingTenant::class => [],
            Events\TenantCreated::class => [
                JobPipeline::make([
                    Jobs\CreateDatabase::class,
                    Jobs\MigrateDatabase::class,
                    // Jobs\SeedDatabase::class,

                    // Your own jobs to prepare the tenant.
                    // Provision API keys, create S3 buckets, anything you want!

                ])->send(function (Events\TenantCreated $event) {
                    return $event->tenant;
                })->shouldBeQueued(false), // `false` by default, but you probably want to make this `true` for production.
            ],
            Events\SavingTenant::class => [],
            Events\TenantSaved::class => [],
            Events\UpdatingTenant::class => [],
            Events\TenantUpdated::class => [],
            Events\DeletingTenant::class => [],
            Events\TenantDeleted::class => [
                JobPipeline::make([
                    Jobs\DeleteDatabase::class,
                ])->send(function (Events\TenantDeleted $event) {
                    return $event->tenant;
                })->shouldBeQueued(false), // `false` by default, but you probably want to make this `true` for production.
            ],

            // Domain events
            Events\CreatingDomain::class => [],
            Events\DomainCreated::class => [],
            Events\SavingDomain::class => [],
            Events\DomainSaved::class => [],
            Events\UpdatingDomain::class => [],
            Events\DomainUpdated::class => [],
            Events\DeletingDomain::class => [],
            Events\DomainDeleted::class => [],

            // Database events
            Events\DatabaseCreated::class => [],
            Events\DatabaseMigrated::class => [],
            Events\DatabaseSeeded::class => [],
            Events\DatabaseRolledBack::class => [],
            Events\DatabaseDeleted::class => [],

            // Tenancy events
            Events\InitializingTenancy::class => [],
            Events\TenancyInitialized::class => [
                Listeners\BootstrapTenancy::class,
            ],

            Events\EndingTenancy::class => [],
            Events\TenancyEnded::class => [
                Listeners\RevertToCentralContext::class,
            ],

            Events\BootstrappingTenancy::class => [],
            Events\TenancyBootstrapped::class => [],
            Events\RevertingToCentralContext::class => [],
            Events\RevertedToCentralContext::class => [],

            // Resource syncing
            Events\SyncedResourceSaved::class => [
                Listeners\UpdateSyncedResource::class,
            ],

            // Fired only when a synced resource is changed in a different DB than the origin DB (to avoid infinite loops)
            Events\SyncedResourceChangedInForeignDatabase::class => [],
        ];
    }

    public function register()
    {
        //
    }

    public function boot()
    {
        $this->bootEvents();
        $this->mapRoutes();

        $this->makeTenancyMiddlewareHighestPriority();
    }

    protected function bootEvents()
    {
        foreach ($this->events() as $event => $listeners) {
            foreach ($listeners as $listener) {
                if ($listener instanceof JobPipeline) {
                    $listener = $listener->toListener();
                }

                Event::listen($event, $listener);
            }
        }
    }

    protected function mapRoutes()
    {
        $this->app->booted(function () {
            if (file_exists(base_path('routes/tenant.php'))) {
                Route::namespace(static::$controllerNamespace)
                    ->group(base_path('routes/tenant.php'));
            }
        });
    }

    protected function makeTenancyMiddlewareHighestPriority()
    {
        $tenancyMiddleware = [
            // Even higher priority than the initialization middleware
            Middleware\PreventAccessFromCentralDomains::class,

            Middleware\InitializeTenancyByDomain::class,
            Middleware\InitializeTenancyBySubdomain::class,
            Middleware\InitializeTenancyByDomainOrSubdomain::class,
            Middleware\InitializeTenancyByPath::class,
            Middleware\InitializeTenancyByRequestData::class,
        ];

        foreach (array_reverse($tenancyMiddleware) as $middleware) {
            $this->app[\Illuminate\Contracts\Http\Kernel::class]->prependToMiddlewarePriority($middleware);
        }
    }
}
</file>

<file path="config/app.php">
<?php

return [

    /*
    |--------------------------------------------------------------------------
    | Application Name
    |--------------------------------------------------------------------------
    |
    | This value is the name of your application, which will be used when the
    | framework needs to place the application's name in a notification or
    | other UI elements where an application name needs to be displayed.
    |
    */

    'name' => env('APP_NAME', 'Laravel'),

    /*
    |--------------------------------------------------------------------------
    | Application Environment
    |--------------------------------------------------------------------------
    |
    | This value determines the "environment" your application is currently
    | running in. This may determine how you prefer to configure various
    | services the application utilizes. Set this in your ".env" file.
    |
    */

    'env' => env('APP_ENV', 'production'),

    /*
    |--------------------------------------------------------------------------
    | Application Debug Mode
    |--------------------------------------------------------------------------
    |
    | When your application is in debug mode, detailed error messages with
    | stack traces will be shown on every error that occurs within your
    | application. If disabled, a simple generic error page is shown.
    |
    */

    'debug' => (bool) env('APP_DEBUG', false),

    /*
    |--------------------------------------------------------------------------
    | Application URL
    |--------------------------------------------------------------------------
    |
    | This URL is used by the console to properly generate URLs when using
    | the Artisan command line tool. You should set this to the root of
    | the application so that it's available within Artisan commands.
    |
    */

    'url' => env('APP_URL', 'http://localhost'),

    /*
    |--------------------------------------------------------------------------
    | Application Timezone
    |--------------------------------------------------------------------------
    |
    | Here you may specify the default timezone for your application, which
    | will be used by the PHP date and date-time functions. The timezone
    | is set to "UTC" by default as it is suitable for most use cases.
    |
    */

    'timezone' => 'UTC',

    /*
    |--------------------------------------------------------------------------
    | Application Locale Configuration
    |--------------------------------------------------------------------------
    |
    | The application locale determines the default locale that will be used
    | by Laravel's translation / localization methods. This option can be
    | set to any locale for which you plan to have translation strings.
    |
    */

    'locale' => env('APP_LOCALE', 'en'),

    'fallback_locale' => env('APP_FALLBACK_LOCALE', 'en'),

    'faker_locale' => env('APP_FAKER_LOCALE', 'en_US'),

    /*
    |--------------------------------------------------------------------------
    | Encryption Key
    |--------------------------------------------------------------------------
    |
    | This key is utilized by Laravel's encryption services and should be set
    | to a random, 32 character string to ensure that all encrypted values
    | are secure. You should do this prior to deploying the application.
    |
    */

    'cipher' => 'AES-256-CBC',

    'key' => env('APP_KEY'),

    'previous_keys' => [
        ...array_filter(
            explode(',', (string) env('APP_PREVIOUS_KEYS', ''))
        ),
    ],

    /*
    |--------------------------------------------------------------------------
    | Maintenance Mode Driver
    |--------------------------------------------------------------------------
    |
    | These configuration options determine the driver used to determine and
    | manage Laravel's "maintenance mode" status. The "cache" driver will
    | allow maintenance mode to be controlled across multiple machines.
    |
    | Supported drivers: "file", "cache"
    |
    */

    'maintenance' => [
        'driver' => env('APP_MAINTENANCE_DRIVER', 'file'),
        'store' => env('APP_MAINTENANCE_STORE', 'database'),
    ],

];
</file>

<file path="config/auth.php">
<?php

return [

    /*
    |--------------------------------------------------------------------------
    | Authentication Defaults
    |--------------------------------------------------------------------------
    |
    | This option defines the default authentication "guard" and password
    | reset "broker" for your application. You may change these values
    | as required, but they're a perfect start for most applications.
    |
    */

    'defaults' => [
        'guard' => env('AUTH_GUARD', 'web'),
        'passwords' => env('AUTH_PASSWORD_BROKER', 'users'),
    ],

    /*
    |--------------------------------------------------------------------------
    | Authentication Guards
    |--------------------------------------------------------------------------
    |
    | Next, you may define every authentication guard for your application.
    | Of course, a great default configuration has been defined for you
    | which utilizes session storage plus the Eloquent user provider.
    |
    | All authentication guards have a user provider, which defines how the
    | users are actually retrieved out of your database or other storage
    | system used by the application. Typically, Eloquent is utilized.
    |
    | Supported: "session"
    |
    */

    'guards' => [
        'web' => [
            'driver' => 'session',
            'provider' => 'users',
        ],
    ],

    /*
    |--------------------------------------------------------------------------
    | User Providers
    |--------------------------------------------------------------------------
    |
    | All authentication guards have a user provider, which defines how the
    | users are actually retrieved out of your database or other storage
    | system used by the application. Typically, Eloquent is utilized.
    |
    | If you have multiple user tables or models you may configure multiple
    | providers to represent the model / table. These providers may then
    | be assigned to any extra authentication guards you have defined.
    |
    | Supported: "database", "eloquent"
    |
    */

    'providers' => [
        'users' => [
            'driver' => 'eloquent',
            'model' => env('AUTH_MODEL', App\Models\User::class),
        ],

        // 'users' => [
        //     'driver' => 'database',
        //     'table' => 'users',
        // ],
    ],

    /*
    |--------------------------------------------------------------------------
    | Resetting Passwords
    |--------------------------------------------------------------------------
    |
    | These configuration options specify the behavior of Laravel's password
    | reset functionality, including the table utilized for token storage
    | and the user provider that is invoked to actually retrieve users.
    |
    | The expiry time is the number of minutes that each reset token will be
    | considered valid. This security feature keeps tokens short-lived so
    | they have less time to be guessed. You may change this as needed.
    |
    | The throttle setting is the number of seconds a user must wait before
    | generating more password reset tokens. This prevents the user from
    | quickly generating a very large amount of password reset tokens.
    |
    */

    'passwords' => [
        'users' => [
            'provider' => 'users',
            'table' => env('AUTH_PASSWORD_RESET_TOKEN_TABLE', 'password_reset_tokens'),
            'expire' => 60,
            'throttle' => 60,
        ],
    ],

    /*
    |--------------------------------------------------------------------------
    | Password Confirmation Timeout
    |--------------------------------------------------------------------------
    |
    | Here you may define the number of seconds before a password confirmation
    | window expires and users are asked to re-enter their password via the
    | confirmation screen. By default, the timeout lasts for three hours.
    |
    */

    'password_timeout' => env('AUTH_PASSWORD_TIMEOUT', 10800),

];
</file>

<file path="config/database.php">
<?php

use Illuminate\Support\Str;

return [

    /*
    |--------------------------------------------------------------------------
    | Default Database Connection Name
    |--------------------------------------------------------------------------
    |
    | Here you may specify which of the database connections below you wish
    | to use as your default connection for database operations. This is
    | the connection which will be utilized unless another connection
    | is explicitly specified when you execute a query / statement.
    |
    */

    'default' => env('DB_CONNECTION', 'sqlite'),

    /*
    |--------------------------------------------------------------------------
    | Database Connections
    |--------------------------------------------------------------------------
    |
    | Below are all of the database connections defined for your application.
    | An example configuration is provided for each database system which
    | is supported by Laravel. You're free to add / remove connections.
    |
    */

    'connections' => [

        'sqlite' => [
            'driver' => 'sqlite',
            'url' => env('DB_URL'),
            'database' => env('DB_DATABASE', database_path('database.sqlite')),
            'prefix' => '',
            'foreign_key_constraints' => env('DB_FOREIGN_KEYS', true),
            'busy_timeout' => null,
            'journal_mode' => null,
            'synchronous' => null,
            'transaction_mode' => 'DEFERRED',
        ],

        'mysql' => [
            'driver' => 'mysql',
            'url' => env('DB_URL'),
            'host' => env('DB_HOST', '127.0.0.1'),
            'port' => env('DB_PORT', '3306'),
            'database' => env('DB_DATABASE', 'laravel'),
            'username' => env('DB_USERNAME', 'root'),
            'password' => env('DB_PASSWORD', ''),
            'unix_socket' => env('DB_SOCKET', ''),
            'charset' => env('DB_CHARSET', 'utf8mb4'),
            'collation' => env('DB_COLLATION', 'utf8mb4_unicode_ci'),
            'prefix' => '',
            'prefix_indexes' => true,
            'strict' => true,
            'engine' => null,
            'options' => extension_loaded('pdo_mysql') ? array_filter([
                (PHP_VERSION_ID >= 80500 ? \Pdo\Mysql::ATTR_SSL_CA : \PDO::MYSQL_ATTR_SSL_CA) => env('MYSQL_ATTR_SSL_CA'),
            ]) : [],
        ],

        'central' => [
            'driver' => 'mysql',
            'host' => env('DB_HOST', '127.0.0.1'),
            'port' => env('DB_PORT', '3306'),
            'database' => env('DB_DATABASE', 'canna_central'),
            'username' => env('DB_USERNAME', 'root'),
            'password' => env('DB_PASSWORD', ''),
            'unix_socket' => env('DB_SOCKET', ''),
            'charset' => env('DB_CHARSET', 'utf8mb4'),
            'collation' => env('DB_COLLATION', 'utf8mb4_unicode_ci'),
            'prefix' => '',
            'prefix_indexes' => true,
            'strict' => true,
            'engine' => null,
            'options' => extension_loaded('pdo_mysql') ? array_filter([
                (PHP_VERSION_ID >= 80500 ? \Pdo\Mysql::ATTR_SSL_CA : \PDO::MYSQL_ATTR_SSL_CA) => env('MYSQL_ATTR_SSL_CA'),
            ]) : [],
        ],

        'tenant' => [
            'driver' => 'mysql',
            'host' => env('DB_HOST', '127.0.0.1'),
            'port' => env('DB_PORT', '3306'),
            'database' => null,
            'username' => env('DB_USERNAME', 'root'),
            'password' => env('DB_PASSWORD', ''),
            'unix_socket' => env('DB_SOCKET', ''),
            'charset' => env('DB_CHARSET', 'utf8mb4'),
            'collation' => env('DB_COLLATION', 'utf8mb4_unicode_ci'),
            'prefix' => '',
            'prefix_indexes' => true,
            'strict' => true,
            'engine' => null,
            'options' => extension_loaded('pdo_mysql') ? array_filter([
                (PHP_VERSION_ID >= 80500 ? \Pdo\Mysql::ATTR_SSL_CA : \PDO::MYSQL_ATTR_SSL_CA) => env('MYSQL_ATTR_SSL_CA'),
            ]) : [],
        ],

        'mariadb' => [
            'driver' => 'mariadb',
            'url' => env('DB_URL'),
            'host' => env('DB_HOST', '127.0.0.1'),
            'port' => env('DB_PORT', '3306'),
            'database' => env('DB_DATABASE', 'laravel'),
            'username' => env('DB_USERNAME', 'root'),
            'password' => env('DB_PASSWORD', ''),
            'unix_socket' => env('DB_SOCKET', ''),
            'charset' => env('DB_CHARSET', 'utf8mb4'),
            'collation' => env('DB_COLLATION', 'utf8mb4_unicode_ci'),
            'prefix' => '',
            'prefix_indexes' => true,
            'strict' => true,
            'engine' => null,
            'options' => extension_loaded('pdo_mysql') ? array_filter([
                (PHP_VERSION_ID >= 80500 ? \Pdo\Mysql::ATTR_SSL_CA : \PDO::MYSQL_ATTR_SSL_CA) => env('MYSQL_ATTR_SSL_CA'),
            ]) : [],
        ],

        'pgsql' => [
            'driver' => 'pgsql',
            'url' => env('DB_URL'),
            'host' => env('DB_HOST', '127.0.0.1'),
            'port' => env('DB_PORT', '5432'),
            'database' => env('DB_DATABASE', 'laravel'),
            'username' => env('DB_USERNAME', 'root'),
            'password' => env('DB_PASSWORD', ''),
            'charset' => env('DB_CHARSET', 'utf8'),
            'prefix' => '',
            'prefix_indexes' => true,
            'search_path' => 'public',
            'sslmode' => env('DB_SSLMODE', 'prefer'),
        ],

        'sqlsrv' => [
            'driver' => 'sqlsrv',
            'url' => env('DB_URL'),
            'host' => env('DB_HOST', 'localhost'),
            'port' => env('DB_PORT', '1433'),
            'database' => env('DB_DATABASE', 'laravel'),
            'username' => env('DB_USERNAME', 'root'),
            'password' => env('DB_PASSWORD', ''),
            'charset' => env('DB_CHARSET', 'utf8'),
            'prefix' => '',
            'prefix_indexes' => true,
            // 'encrypt' => env('DB_ENCRYPT', 'yes'),
            // 'trust_server_certificate' => env('DB_TRUST_SERVER_CERTIFICATE', 'false'),
        ],

    ],

    /*
    |--------------------------------------------------------------------------
    | Migration Repository Table
    |--------------------------------------------------------------------------
    |
    | This table keeps track of all the migrations that have already run for
    | your application. Using this information, we can determine which of
    | the migrations on disk haven't actually been run on the database.
    |
    */

    'migrations' => [
        'table' => 'migrations',
        'update_date_on_publish' => true,
    ],

    /*
    |--------------------------------------------------------------------------
    | Redis Databases
    |--------------------------------------------------------------------------
    |
    | Redis is an open source, fast, and advanced key-value store that also
    | provides a richer body of commands than a typical key-value system
    | such as Memcached. You may define your connection settings here.
    |
    */

    'redis' => [

        'client' => env('REDIS_CLIENT', 'phpredis'),

        'options' => [
            'cluster' => env('REDIS_CLUSTER', 'redis'),
            'prefix' => env('REDIS_PREFIX', Str::slug((string) env('APP_NAME', 'laravel')).'-database-'),
            'persistent' => env('REDIS_PERSISTENT', false),
        ],

        'default' => [
            'url' => env('REDIS_URL'),
            'host' => env('REDIS_HOST', '127.0.0.1'),
            'username' => env('REDIS_USERNAME'),
            'password' => env('REDIS_PASSWORD'),
            'port' => env('REDIS_PORT', '6379'),
            'database' => env('REDIS_DB', '0'),
            'max_retries' => env('REDIS_MAX_RETRIES', 3),
            'backoff_algorithm' => env('REDIS_BACKOFF_ALGORITHM', 'decorrelated_jitter'),
            'backoff_base' => env('REDIS_BACKOFF_BASE', 100),
            'backoff_cap' => env('REDIS_BACKOFF_CAP', 1000),
        ],

        'cache' => [
            'url' => env('REDIS_URL'),
            'host' => env('REDIS_HOST', '127.0.0.1'),
            'username' => env('REDIS_USERNAME'),
            'password' => env('REDIS_PASSWORD'),
            'port' => env('REDIS_PORT', '6379'),
            'database' => env('REDIS_CACHE_DB', '1'),
            'max_retries' => env('REDIS_MAX_RETRIES', 3),
            'backoff_algorithm' => env('REDIS_BACKOFF_ALGORITHM', 'decorrelated_jitter'),
            'backoff_base' => env('REDIS_BACKOFF_BASE', 100),
            'backoff_cap' => env('REDIS_BACKOFF_CAP', 1000),
        ],

    ],

];
</file>

<file path="config/tenancy.php">
<?php

declare(strict_types=1);

use Stancl\Tenancy\Database\Models\Domain;
use Stancl\Tenancy\Database\Models\Tenant;

return [
    'tenant_model' => Tenant::class,
    'id_generator' => Stancl\Tenancy\UUIDGenerator::class,

    'domain_model' => Domain::class,

    /**
     * The list of domains hosting your central app.
     *
     * Only relevant if you're using the domain or subdomain identification middleware.
     */
    'central_domains' => [
        'admin.localhost',
        'admin.cannarewards.io',
    ],

    /**
     * Tenancy bootstrappers are executed when tenancy is initialized.
     * Their responsibility is making Laravel features tenant-aware.
     *
     * To configure their behavior, see the config keys below.
     */
    'bootstrappers' => [
        Stancl\Tenancy\Bootstrappers\DatabaseTenancyBootstrapper::class,
        Stancl\Tenancy\Bootstrappers\CacheTenancyBootstrapper::class,
        Stancl\Tenancy\Bootstrappers\FilesystemTenancyBootstrapper::class,
        Stancl\Tenancy\Bootstrappers\QueueTenancyBootstrapper::class,
        // Stancl\Tenancy\Bootstrappers\RedisTenancyBootstrapper::class, // Note: phpredis is needed
    ],

    /**
     * Database tenancy config. Used by DatabaseTenancyBootstrapper.
     */
    'database' => [
        'central_connection' => 'central',

        /**
         * Connection used as a "template" for the dynamically created tenant database connection.
         * Note: don't name your template connection tenant. That name is reserved by package.
         */
        'template_tenant_connection' => 'tenant',

        /**
         * Tenant database names are created like this:
         * prefix + tenant_id + suffix.
         */
        'prefix' => 'tenant',
        'suffix' => '',

        /**
         * TenantDatabaseManagers are classes that handle the creation & deletion of tenant databases.
         */
        'managers' => [
            'sqlite' => Stancl\Tenancy\TenantDatabaseManagers\SQLiteDatabaseManager::class,
            'mysql' => Stancl\Tenancy\TenantDatabaseManagers\MySQLDatabaseManager::class,
            'pgsql' => Stancl\Tenancy\TenantDatabaseManagers\PostgreSQLDatabaseManager::class,

        /**
         * Use this database manager for MySQL to have a DB user created for each tenant database.
         * You can customize the grants given to these users by changing the $grants property.
         */
            // 'mysql' => Stancl\Tenancy\TenantDatabaseManagers\PermissionControlledMySQLDatabaseManager::class,

        /**
         * Disable the pgsql manager above, and enable the one below if you
         * want to separate tenant DBs by schemas rather than databases.
         */
            // 'pgsql' => Stancl\Tenancy\TenantDatabaseManagers\PostgreSQLSchemaManager::class, // Separate by schema instead of database
        ],
    ],

    /**
     * Cache tenancy config. Used by CacheTenancyBootstrapper.
     *
     * This works for all Cache facade calls, cache() helper
     * calls and direct calls to injected cache stores.
     *
     * Each key in cache will have a tag applied on it. This tag is used to
     * scope the cache both when writing to it and when reading from it.
     *
     * You can clear cache selectively by specifying the tag.
     */
    'cache' => [
        'tag_base' => 'tenant', // This tag_base, followed by the tenant_id, will form a tag that will be applied on each cache call.
    ],

    /**
     * Filesystem tenancy config. Used by FilesystemTenancyBootstrapper.
     * https://tenancyforlaravel.com/docs/v3/tenancy-bootstrappers/#filesystem-tenancy-boostrapper.
     */
    'filesystem' => [
        /**
         * Each disk listed in the 'disks' array will be suffixed by the suffix_base, followed by the tenant_id.
         */
        'suffix_base' => 'tenant',
        'disks' => [
            'local',
            'public',
            // 's3',
        ],

        /**
         * Use this for local disks.
         *
         * See https://tenancyforlaravel.com/docs/v3/tenancy-bootstrappers/#filesystem-tenancy-boostrapper
         */
        'root_override' => [
            // Disks whose roots should be overridden after storage_path() is suffixed.
            'local' => '%storage_path%/app/',
            'public' => '%storage_path%/app/public/',
        ],

        /**
         * Should storage_path() be suffixed.
         *
         * Note: Disabling this will likely break local disk tenancy. Only disable this if you're using an external file storage service like S3.
         *
         * For the vast majority of applications, this feature should be enabled. But in some
         * edge cases, it can cause issues (like using Passport with Vapor - see #196), so
         * you may want to disable this if you are experiencing these edge case issues.
         */
        'suffix_storage_path' => true,

        /**
         * By default, asset() calls are made multi-tenant too. You can use global_asset() and mix()
         * for global, non-tenant-specific assets. However, you might have some issues when using
         * packages that use asset() calls inside the tenant app. To avoid such issues, you can
         * disable asset() helper tenancy and explicitly use tenant_asset() calls in places
         * where you want to use tenant-specific assets (product images, avatars, etc).
         */
        'asset_helper_tenancy' => true,
    ],

    /**
     * Redis tenancy config. Used by RedisTenancyBootstrapper.
     *
     * Note: You need phpredis to use Redis tenancy.
     *
     * Note: You don't need to use this if you're using Redis only for cache.
     * Redis tenancy is only relevant if you're making direct Redis calls,
     * either using the Redis facade or by injecting it as a dependency.
     */
    'redis' => [
        'prefix_base' => 'tenant', // Each key in Redis will be prepended by this prefix_base, followed by the tenant id.
        'prefixed_connections' => [ // Redis connections whose keys are prefixed, to separate one tenant's keys from another.
            // 'default',
        ],
    ],

    /**
     * Features are classes that provide additional functionality
     * not needed for tenancy to be bootstrapped. They are run
     * regardless of whether tenancy has been initialized.
     *
     * See the documentation page for each class to
     * understand which ones you want to enable.
     */
    'features' => [
        // Stancl\Tenancy\Features\UserImpersonation::class,
        // Stancl\Tenancy\Features\TelescopeTags::class,
        Stancl\Tenancy\Features\UniversalRoutes::class, // Enable universal routes for global assets
        // Stancl\Tenancy\Features\TenantConfig::class, // https://tenancyforlaravel.com/docs/v3/features/tenant-config
        // Stancl\Tenancy\Features\CrossDomainRedirect::class, // https://tenancyforlaravel.com/docs/v3/features/cross-domain-redirect
        // Stancl\Tenancy\Features\ViteBundler::class,
    ],

    /**
     * Should tenancy routes be registered.
     *
     * Tenancy routes include tenant asset routes. By default, this route is
     * enabled. But it may be useful to disable them if you use external
     * storage (e.g. S3 / Dropbox) or have a custom asset controller.
     */
    'routes' => true,

    /**
     * Parameters used by the tenants:migrate command.
     */
    'migration_parameters' => [
        '--force' => true, // This needs to be true to run migrations in production.
        '--path' => [database_path('migrations/tenant')],
        '--realpath' => true,
    ],

    /**
     * Parameters used by the tenants:seed command.
     */
    'seeder_parameters' => [
        '--class' => 'DatabaseSeeder', // root seeder class
        // '--force' => true, // This needs to be true to seed tenant databases in production
    ],
];
</file>

<file path="config/typescript-transformer.php">
<?php

return [
    /*
     * The paths where typescript-transformer will look for PHP classes
     * to transform, this will be the `app` path by default.
     */

    'auto_discover_types' => [
        app_path(),
    ],

    /*
     * Collectors will search for classes in the `auto_discover_types` paths and choose the correct
     * transformer to transform them. By default, we include a DefaultCollector which will search
     * for @typescript annotated and #[TypeScript] attributed classes to transform.
     */

    'collectors' => [
        Spatie\TypeScriptTransformer\Collectors\DefaultCollector::class,
        Spatie\TypeScriptTransformer\Collectors\EnumCollector::class,
    ],

    /*
     * Transformers take PHP classes(e.g., enums) as an input and will output
     * a TypeScript representation of the PHP class.
     */

    'transformers' => [
        Spatie\LaravelTypeScriptTransformer\Transformers\SpatieStateTransformer::class,
        Spatie\LaravelTypeScriptTransformer\Transformers\DtoTransformer::class,
    ],

    /*
     * In your classes, you sometimes have types that should always be replaced
     * by the same TypeScript representations. For example, you can replace a
     * Datetime always with a string. You define these replacements here.
     */

    'default_type_replacements' => [
        DateTime::class => 'string',
        DateTimeImmutable::class => 'string',
        Carbon\CarbonInterface::class => 'string',
        Carbon\CarbonImmutable::class => 'string',
        Carbon\Carbon::class => 'string',
    ],

    /*
     * The package will write the generated TypeScript to this file.
     */

    'output_file' => resource_path('js/types/generated.d.ts'),

    /*
     * When the package is writing types to the output file, a writer is used to
     * determine the format. By default, this is the `TypeDefinitionWriter`.
     * But you can also use the `ModuleWriter` or implement your own.
     */

    'writer' => Spatie\TypeScriptTransformer\Writers\TypeDefinitionWriter::class,

    /*
     * The generated TypeScript file can be formatted. We ship a Prettier formatter
     * out of the box: `PrettierFormatter` but you can also implement your own one.
     * The generated TypeScript will not be formatted when no formatter was set.
     */

    'formatter' => null,

    /*
     * Enums can be transformed into types or native TypeScript enums, by default
     * the package will transform them to types.
     */

    'transform_to_native_enums' => false,

    /*
     * By default, this package will convert PHP nullable properties to TypeScript
     * types using a `null` type union. Setting `transform_null_to_optional` will
     * make them optional instead.
     */

    'transform_null_to_optional' => false,
];
</file>

<file path="database/factories/UserFactory.php">
<?php

namespace Database\Factories;

use Illuminate\Database\Eloquent\Factories\Factory;
use Illuminate\Support\Facades\Hash;
use Illuminate\Support\Str;

/**
 * @extends \Illuminate\Database\Eloquent\Factories\Factory<\App\Models\User>
 */
class UserFactory extends Factory
{
    /**
     * The current password being used by the factory.
     */
    protected static ?string $password;

    /**
     * Define the model's default state.
     *
     * @return array<string, mixed>
     */
    public function definition(): array
    {
        return [
            'name' => fake()->name(),
            'email' => fake()->unique()->safeEmail(),
            'email_verified_at' => now(),
            'password' => static::$password ??= Hash::make('password'),
            'remember_token' => Str::random(10),
        ];
    }

    /**
     * Indicate that the model's email address should be unverified.
     */
    public function unverified(): static
    {
        return $this->state(fn (array $attributes) => [
            'email_verified_at' => null,
        ]);
    }
}
</file>

<file path="database/migrations/tenant/2026_01_09_071658_create_tenant_users_table.php">
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    /**
     * Run the migrations.
     */
    public function up(): void
    {
        Schema::create('tenant_users', function (Blueprint $table) {
            $table->bigIncrements('id');
            $table->uuid('uuid')->unique();
            $table->string('phone')->unique();
            $table->string('email')->unique()->nullable();
            $table->string('name')->nullable();
            $table->date('dob')->nullable();
            $table->integer('points_balance')->default(0);
            $table->integer('lifetime_points')->default(0);
            $table->string('current_rank_key')->default('member');
            $table->string('referral_code')->unique();
            $table->bigInteger('referred_by_id')->unsigned()->nullable();
            $table->json('signals')->nullable();
            $table->boolean('marketing_opt_in')->default(false);
            $table->timestamp('email_verified_at')->nullable();
            $table->string('password')->nullable();
            $table->rememberToken();
            $table->timestamp('deleted_at')->nullable();
            $table->timestamps();

            $table->foreign('referred_by_id')->references('id')->on('tenant_users')->onDelete('set null');
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        Schema::dropIfExists('tenant_users');
    }
};
</file>

<file path="database/migrations/tenant/2026_01_12_221301_create_commercial_goods_table.php">
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    /**
     * Run the migrations.
     */
    public function up(): void
    {
        Schema::create('commercial_goods', function (Blueprint $table) {
            $table->id();
            $table->string('sku')->unique();
            $table->string('name');
            $table->integer('points_awarded');
            $table->integer('msrp_cents');
            $table->enum('strain_type', ['indica', 'sativa', 'hybrid', 'cbd']);
            $table->string('image_url')->nullable();
            $table->boolean('is_active')->default(true);
            $table->timestamps();
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        Schema::dropIfExists('commercial_goods');
    }
};
</file>

<file path="database/migrations/tenant/2026_01_12_221302_create_reward_codes_table.php">
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    /**
     * Run the migrations.
     */
    public function up(): void
    {
        Schema::create('reward_codes', function (Blueprint $table) {
            $table->string('code', 16)->primary();
            $table->foreignId('commercial_good_id')->constrained('commercial_goods');
            $table->uuid('batch_id');
            $table->enum('status', ['generated', 'active', 'used', 'void'])->default('generated');
            $table->foreignId('user_id')->nullable()->constrained('tenant_users');
            $table->timestamp('claimed_at')->nullable();
            $table->timestamps();
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        Schema::dropIfExists('reward_codes');
    }
};
</file>

<file path="database/migrations/0001_01_01_000000_create_users_table.php">
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    /**
     * Run the migrations.
     */
    public function up(): void
    {
        Schema::create('users', function (Blueprint $table) {
            $table->id();
            $table->string('name');
            $table->string('email')->unique();
            $table->timestamp('email_verified_at')->nullable();
            $table->string('password');
            $table->rememberToken();
            $table->timestamps();
        });

        Schema::create('password_reset_tokens', function (Blueprint $table) {
            $table->string('email')->primary();
            $table->string('token');
            $table->timestamp('created_at')->nullable();
        });

        Schema::create('sessions', function (Blueprint $table) {
            $table->string('id')->primary();
            $table->foreignId('user_id')->nullable()->index();
            $table->string('ip_address', 45)->nullable();
            $table->text('user_agent')->nullable();
            $table->longText('payload');
            $table->integer('last_activity')->index();
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        Schema::dropIfExists('users');
        Schema::dropIfExists('password_reset_tokens');
        Schema::dropIfExists('sessions');
    }
};
</file>

<file path="database/migrations/0001_01_01_000001_create_cache_table.php">
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    /**
     * Run the migrations.
     */
    public function up(): void
    {
        Schema::create('cache', function (Blueprint $table) {
            $table->string('key')->primary();
            $table->mediumText('value');
            $table->integer('expiration');
        });

        Schema::create('cache_locks', function (Blueprint $table) {
            $table->string('key')->primary();
            $table->string('owner');
            $table->integer('expiration');
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        Schema::dropIfExists('cache');
        Schema::dropIfExists('cache_locks');
    }
};
</file>

<file path="database/migrations/0001_01_01_000002_create_jobs_table.php">
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    /**
     * Run the migrations.
     */
    public function up(): void
    {
        Schema::create('jobs', function (Blueprint $table) {
            $table->id();
            $table->string('queue')->index();
            $table->longText('payload');
            $table->unsignedTinyInteger('attempts');
            $table->unsignedInteger('reserved_at')->nullable();
            $table->unsignedInteger('available_at');
            $table->unsignedInteger('created_at');
        });

        Schema::create('job_batches', function (Blueprint $table) {
            $table->string('id')->primary();
            $table->string('name');
            $table->integer('total_jobs');
            $table->integer('pending_jobs');
            $table->integer('failed_jobs');
            $table->longText('failed_job_ids');
            $table->mediumText('options')->nullable();
            $table->integer('cancelled_at')->nullable();
            $table->integer('created_at');
            $table->integer('finished_at')->nullable();
        });

        Schema::create('failed_jobs', function (Blueprint $table) {
            $table->id();
            $table->string('uuid')->unique();
            $table->text('connection');
            $table->text('queue');
            $table->longText('payload');
            $table->longText('exception');
            $table->timestamp('failed_at')->useCurrent();
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        Schema::dropIfExists('jobs');
        Schema::dropIfExists('job_batches');
        Schema::dropIfExists('failed_jobs');
    }
};
</file>

<file path="database/migrations/2019_09_15_000010_create_tenants_table.php">
<?php

declare(strict_types=1);

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

class CreateTenantsTable extends Migration
{
    /**
     * Run the migrations.
     */
    public function up(): void
    {
        Schema::create('tenants', function (Blueprint $table) {
            $table->string('id')->primary();

            // your custom columns may go here

            $table->timestamps();
            $table->json('data')->nullable();
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        Schema::dropIfExists('tenants');
    }
}
</file>

<file path="database/migrations/2019_09_15_000020_create_domains_table.php">
<?php

declare(strict_types=1);

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

class CreateDomainsTable extends Migration
{
    /**
     * Run the migrations.
     */
    public function up(): void
    {
        Schema::create('domains', function (Blueprint $table) {
            $table->increments('id');
            $table->string('domain', 255)->unique();
            $table->string('tenant_id');

            $table->timestamps();
            $table->foreign('tenant_id')->references('id')->on('tenants')->onUpdate('cascade')->onDelete('cascade');
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        Schema::dropIfExists('domains');
    }
}
</file>

<file path="database/migrations/2026_01_09_071829_update_tenants_table_add_brand_config.php">
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    /**
     * Run the migrations.
     */
    public function up(): void
    {
        Schema::table('tenants', function (Blueprint $table) {
            $table->string('brand_name')->after('id');
            $table->string('plan')->after('brand_name')->default('enterprise');
            $table->json('config')->after('plan')->nullable();
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        Schema::table('tenants', function (Blueprint $table) {
            $table->dropColumn(['brand_name', 'config', 'plan']);
        });
    }
};
</file>

<file path="database/seeders/DatabaseSeeder.php">
<?php

namespace Database\Seeders;

use App\Models\User;
use Illuminate\Database\Console\Seeds\WithoutModelEvents;
use Illuminate\Database\Seeder;

class DatabaseSeeder extends Seeder
{
    use WithoutModelEvents;

    /**
     * Seed the application's database.
     */
    public function run(): void
    {
        // User::factory(10)->create();

        User::factory()->create([
            'name' => 'Test User',
            'email' => 'test@example.com',
        ]);
    }
}
</file>

<file path="database/seeders/RealWorldSeeder.php">
<?php

namespace Database\Seeders;

use App\Models\Tenant;
use App\Models\Tenant\CommercialGood;
use App\Models\Tenant\RewardCode;
use Illuminate\Database\Seeder;

class RealWorldSeeder extends Seeder
{
    public function run(): void
    {
        // Create Tenant A: "Dime Industries"
        $dime = Tenant::create([
            'id' => 'dime',
            'brand_name' => 'Dime Industries',
            'plan' => 'enterprise',
            'config' => [
                'theme' => [
                    'primary_color' => '#C6A355',
                    'font_family' => 'Inter',
                    'radius' => '0.5rem',
                ],
                'copy' => [
                    'points_label' => 'Coins',
                    'scan_cta' => 'Stack Up',
                ],
                'features' => [
                    'referrals_enabled' => true,
                    'age_gate_strict' => true,
                ],
            ],
        ]);

        // Create database for dime tenant
        $dime->database()->manager()->createDatabase($dime);

        // Switch to dime tenant context to populate its tables
        tenancy()->initialize($dime);

        // Create 50 products for Dime
        for ($i = 1; $i <= 50; $i++) {
            CommercialGood::create([
                'sku' => 'DIME-'.str_pad((string) $i, 3, '0', STR_PAD_LEFT),
                'name' => 'Dime Product #'.$i,
                'points_awarded' => rand(50, 200),
                'msrp_cents' => rand(500, 5000),
                'strain_type' => ['indica', 'sativa', 'hybrid', 'cbd'][array_rand(['indica', 'sativa', 'hybrid', 'cbd'])],
                'image_url' => 'https://example.com/products/dime-'.$i.'.jpg',
                'is_active' => true,
            ]);
        }

        // Create reward items for Dime
        $ranks = ['member' => 0, 'silver' => 500, 'gold' => 2000, 'rose_gold' => 10000];

        foreach ($ranks as $rank => $threshold) {
            RewardCode::create([
                'name' => ucfirst($rank).' Tier Reward',
                'points_cost' => $threshold,
                'cost_basis_cents' => 0,
                'stock_status' => 'in_stock',
                'required_rank' => $rank !== 'member' ? $rank : null,
                'is_featured' => false,
            ]);
        }

        // Create Tenant B: "Cookies"
        $cookies = Tenant::create([
            'id' => 'cookies',
            'brand_name' => 'Cookies',
            'plan' => 'growth',
            'config' => [
                'theme' => [
                    'primary_color' => '#007AFF',
                    'font_family' => 'Poppins',
                    'radius' => '0.5rem',
                ],
                'copy' => [
                    'points_label' => 'Cookies',
                    'scan_cta' => 'Get Rewards',
                ],
                'features' => [
                    'referrals_enabled' => true,
                    'age_gate_strict' => true,
                ],
            ],
        ]);

        // Create database for cookies tenant
        $cookies->database()->manager()->createDatabase($cookies);

        // Switch to cookies tenant context
        tenancy()->initialize($cookies);

        // Create 10 products for Cookies
        for ($i = 1; $i <= 10; $i++) {
            CommercialGood::create([
                'sku' => 'COOK-'.str_pad((string) $i, 3, '0', STR_PAD_LEFT),
                'name' => 'Cookies Product #'.$i,
                'points_awarded' => rand(75, 150),
                'msrp_cents' => rand(1000, 8000),
                'strain_type' => ['flower', 'pre-roll'][array_rand(['flower', 'pre-roll'])],
                'image_url' => 'https://example.com/products/cookies-'.$i.'.jpg',
                'is_active' => true,
            ]);
        }

        // Create reward items for Cookies
        $cookieRanks = ['scout' => 0, 'leader' => 1000];

        foreach ($cookieRanks as $rank => $threshold) {
            RewardCode::create([
                'name' => ucfirst($rank).' Tier Reward',
                'points_cost' => $threshold,
                'cost_basis_cents' => 0,
                'stock_status' => 'in_stock',
                'required_rank' => $rank !== 'scout' ? $rank : null,
                'is_featured' => false,
            ]);
        }

        // Switch back to central context
        tenancy()->end();
    }
}
</file>

<file path="resources/css/app.css">
@import 'tailwindcss';
@import "tw-animate-css";

@custom-variant dark (&:is(.dark *));

@source '../../vendor/laravel/framework/src/Illuminate/Pagination/resources/views/*.blade.php';
@source '../../storage/framework/views/*.php';
@source '../**/*.blade.php';
@source '../**/*.js';

@theme {
    --font-sans: 'Instrument Sans', ui-sans-serif, system-ui, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji',
        'Segoe UI Symbol', 'Noto Color Emoji';
}

@theme inline {
    --radius-sm: calc(var(--radius) - 4px);
    --radius-md: calc(var(--radius) - 2px);
    --radius-lg: var(--radius);
    --radius-xl: calc(var(--radius) + 4px);
    --radius-2xl: calc(var(--radius) + 8px);
    --radius-3xl: calc(var(--radius) + 12px);
    --radius-4xl: calc(var(--radius) + 16px);
    --color-background: var(--background);
    --color-foreground: var(--foreground);
    --color-card: var(--card);
    --color-card-foreground: var(--card-foreground);
    --color-popover: var(--popover);
    --color-popover-foreground: var(--popover-foreground);
    --color-primary: var(--primary);
    --color-primary-foreground: var(--primary-foreground);
    --color-secondary: var(--secondary);
    --color-secondary-foreground: var(--secondary-foreground);
    --color-muted: var(--muted);
    --color-muted-foreground: var(--muted-foreground);
    --color-accent: var(--accent);
    --color-accent-foreground: var(--accent-foreground);
    --color-destructive: var(--destructive);
    --color-border: var(--border);
    --color-input: var(--input);
    --color-ring: var(--ring);
    --color-chart-1: var(--chart-1);
    --color-chart-2: var(--chart-2);
    --color-chart-3: var(--chart-3);
    --color-chart-4: var(--chart-4);
    --color-chart-5: var(--chart-5);
    --color-sidebar: var(--sidebar);
    --color-sidebar-foreground: var(--sidebar-foreground);
    --color-sidebar-primary: var(--sidebar-primary);
    --color-sidebar-primary-foreground: var(--sidebar-primary-foreground);
    --color-sidebar-accent: var(--sidebar-accent);
    --color-sidebar-accent-foreground: var(--sidebar-accent-foreground);
    --color-sidebar-border: var(--sidebar-border);
    --color-sidebar-ring: var(--sidebar-ring);
}

:root {
    --radius: 0.625rem;
    --background: oklch(1 0 0);
    --foreground: oklch(0.145 0 0);
    --card: oklch(1 0 0);
    --card-foreground: oklch(0.145 0 0);
    --popover: oklch(1 0 0);
    --popover-foreground: oklch(0.145 0 0);
    --primary: oklch(0.205 0 0);
    --primary-foreground: oklch(0.985 0 0);
    --secondary: oklch(0.97 0 0);
    --secondary-foreground: oklch(0.205 0 0);
    --muted: oklch(0.97 0 0);
    --muted-foreground: oklch(0.556 0 0);
    --accent: oklch(0.97 0 0);
    --accent-foreground: oklch(0.205 0 0);
    --destructive: oklch(0.577 0.245 27.325);
    --border: oklch(0.922 0 0);
    --input: oklch(0.922 0 0);
    --ring: oklch(0.708 0 0);
    --chart-1: oklch(0.646 0.222 41.116);
    --chart-2: oklch(0.6 0.118 184.704);
    --chart-3: oklch(0.398 0.07 227.392);
    --chart-4: oklch(0.828 0.189 84.429);
    --chart-5: oklch(0.769 0.188 70.08);
    --sidebar: oklch(0.985 0 0);
    --sidebar-foreground: oklch(0.145 0 0);
    --sidebar-primary: oklch(0.205 0 0);
    --sidebar-primary-foreground: oklch(0.985 0 0);
    --sidebar-accent: oklch(0.97 0 0);
    --sidebar-accent-foreground: oklch(0.205 0 0);
    --sidebar-border: oklch(0.922 0 0);
    --sidebar-ring: oklch(0.708 0 0);
}

.dark {
    --background: oklch(0.145 0 0);
    --foreground: oklch(0.985 0 0);
    --card: oklch(0.205 0 0);
    --card-foreground: oklch(0.985 0 0);
    --popover: oklch(0.205 0 0);
    --popover-foreground: oklch(0.985 0 0);
    --primary: oklch(0.922 0 0);
    --primary-foreground: oklch(0.205 0 0);
    --secondary: oklch(0.269 0 0);
    --secondary-foreground: oklch(0.985 0 0);
    --muted: oklch(0.269 0 0);
    --muted-foreground: oklch(0.708 0 0);
    --accent: oklch(0.269 0 0);
    --accent-foreground: oklch(0.985 0 0);
    --destructive: oklch(0.704 0.191 22.216);
    --border: oklch(1 0 0 / 10%);
    --input: oklch(1 0 0 / 15%);
    --ring: oklch(0.556 0 0);
    --chart-1: oklch(0.488 0.243 264.376);
    --chart-2: oklch(0.696 0.17 162.48);
    --chart-3: oklch(0.769 0.188 70.08);
    --chart-4: oklch(0.627 0.265 303.9);
    --chart-5: oklch(0.645 0.246 16.439);
    --sidebar: oklch(0.205 0 0);
    --sidebar-foreground: oklch(0.985 0 0);
    --sidebar-primary: oklch(0.488 0.243 264.376);
    --sidebar-primary-foreground: oklch(0.985 0 0);
    --sidebar-accent: oklch(0.269 0 0);
    --sidebar-accent-foreground: oklch(0.985 0 0);
    --sidebar-border: oklch(1 0 0 / 10%);
    --sidebar-ring: oklch(0.556 0 0);
}

@layer base {
  * {
    @apply border-border outline-ring/50;
    }
  body {
    @apply bg-background text-foreground;
    }
}
</file>

<file path="resources/js/components/ui/button.tsx">
import * as React from "react"
import { Slot } from "@radix-ui/react-slot"
import { cva, type VariantProps } from "class-variance-authority"

import { cn } from "@/lib/utils"

const buttonVariants = cva(
  "inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium transition-all disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg:not([class*='size-'])]:size-4 shrink-0 [&_svg]:shrink-0 outline-none focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px] aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive",
  {
    variants: {
      variant: {
        default: "bg-primary text-primary-foreground hover:bg-primary/90",
        destructive:
          "bg-destructive text-white hover:bg-destructive/90 focus-visible:ring-destructive/20 dark:focus-visible:ring-destructive/40 dark:bg-destructive/60",
        outline:
          "border bg-background shadow-xs hover:bg-accent hover:text-accent-foreground dark:bg-input/30 dark:border-input dark:hover:bg-input/50",
        secondary:
          "bg-secondary text-secondary-foreground hover:bg-secondary/80",
        ghost:
          "hover:bg-accent hover:text-accent-foreground dark:hover:bg-accent/50",
        link: "text-primary underline-offset-4 hover:underline",
      },
      size: {
        default: "h-9 px-4 py-2 has-[>svg]:px-3",
        sm: "h-8 rounded-md gap-1.5 px-3 has-[>svg]:px-2.5",
        lg: "h-10 rounded-md px-6 has-[>svg]:px-4",
        icon: "size-9",
        "icon-sm": "size-8",
        "icon-lg": "size-10",
      },
    },
    defaultVariants: {
      variant: "default",
      size: "default",
    },
  }
)

function Button({
  className,
  variant = "default",
  size = "default",
  asChild = false,
  ...props
}: React.ComponentProps<"button"> &
  VariantProps<typeof buttonVariants> & {
    asChild?: boolean
  }) {
  const Comp = asChild ? Slot : "button"

  return (
    <Comp
      data-slot="button"
      data-variant={variant}
      data-size={size}
      className={cn(buttonVariants({ variant, size, className }))}
      {...props}
    />
  )
}

export { Button, buttonVariants }
</file>

<file path="resources/js/components/ui/card.tsx">
import * as React from "react"

import { cn } from "@/lib/utils"

function Card({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="card"
      className={cn(
        "bg-card text-card-foreground flex flex-col gap-6 rounded-xl border py-6 shadow-sm",
        className
      )}
      {...props}
    />
  )
}

function CardHeader({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="card-header"
      className={cn(
        "@container/card-header grid auto-rows-min grid-rows-[auto_auto] items-start gap-2 px-6 has-data-[slot=card-action]:grid-cols-[1fr_auto] [.border-b]:pb-6",
        className
      )}
      {...props}
    />
  )
}

function CardTitle({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="card-title"
      className={cn("leading-none font-semibold", className)}
      {...props}
    />
  )
}

function CardDescription({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="card-description"
      className={cn("text-muted-foreground text-sm", className)}
      {...props}
    />
  )
}

function CardAction({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="card-action"
      className={cn(
        "col-start-2 row-span-2 row-start-1 self-start justify-self-end",
        className
      )}
      {...props}
    />
  )
}

function CardContent({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="card-content"
      className={cn("px-6", className)}
      {...props}
    />
  )
}

function CardFooter({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="card-footer"
      className={cn("flex items-center px-6 [.border-t]:pt-6", className)}
      {...props}
    />
  )
}

export {
  Card,
  CardHeader,
  CardFooter,
  CardTitle,
  CardAction,
  CardDescription,
  CardContent,
}
</file>

<file path="resources/js/components/ui/input.tsx">
import * as React from "react"

import { cn } from "@/lib/utils"

function Input({ className, type, ...props }: React.ComponentProps<"input">) {
  return (
    <input
      type={type}
      data-slot="input"
      className={cn(
        "file:text-foreground placeholder:text-muted-foreground selection:bg-primary selection:text-primary-foreground dark:bg-input/30 border-input h-9 w-full min-w-0 rounded-md border bg-transparent px-3 py-1 text-base shadow-xs transition-[color,box-shadow] outline-none file:inline-flex file:h-7 file:border-0 file:bg-transparent file:text-sm file:font-medium disabled:pointer-events-none disabled:cursor-not-allowed disabled:opacity-50 md:text-sm",
        "focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px]",
        "aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive",
        className
      )}
      {...props}
    />
  )
}

export { Input }
</file>

<file path="resources/js/components/ui/label.tsx">
import * as React from "react"
import * as LabelPrimitive from "@radix-ui/react-label"

import { cn } from "@/lib/utils"

function Label({
  className,
  ...props
}: React.ComponentProps<typeof LabelPrimitive.Root>) {
  return (
    <LabelPrimitive.Root
      data-slot="label"
      className={cn(
        "flex items-center gap-2 text-sm leading-none font-medium select-none group-data-[disabled=true]:pointer-events-none group-data-[disabled=true]:opacity-50 peer-disabled:cursor-not-allowed peer-disabled:opacity-50",
        className
      )}
      {...props}
    />
  )
}

export { Label }
</file>

<file path="resources/js/components/ui/sonner.tsx">
"use client"

import {
  CircleCheckIcon,
  InfoIcon,
  Loader2Icon,
  OctagonXIcon,
  TriangleAlertIcon,
} from "lucide-react"
import { useTheme } from "next-themes"
import { Toaster as Sonner, type ToasterProps } from "sonner"

const Toaster = ({ ...props }: ToasterProps) => {
  const { theme = "system" } = useTheme()

  return (
    <Sonner
      theme={theme as ToasterProps["theme"]}
      className="toaster group"
      icons={{
        success: <CircleCheckIcon className="size-4" />,
        info: <InfoIcon className="size-4" />,
        warning: <TriangleAlertIcon className="size-4" />,
        error: <OctagonXIcon className="size-4" />,
        loading: <Loader2Icon className="size-4 animate-spin" />,
      }}
      style={
        {
          "--normal-bg": "var(--popover)",
          "--normal-text": "var(--popover-foreground)",
          "--normal-border": "var(--border)",
          "--border-radius": "var(--radius)",
        } as React.CSSProperties
      }
      {...props}
    />
  )
}

export { Toaster }
</file>

<file path="resources/js/Layouts/AppLayout.tsx">
import React, { ReactNode, useEffect } from 'react';
import { usePage } from '@inertiajs/react';

interface AppLayoutProps {
    children: ReactNode;
    title?: string;
}

interface TenantConfig {
    theme?: {
        primary_color?: string;
        font_family?: string;
        radius?: string;
    };
    copy?: {
        points_label?: string;
        scan_cta?: string;
    };
    features?: {
        referrals_enabled?: boolean;
        age_gate_strict?: boolean;
    };
}

interface User {
    id: number;
    name: string;
    email: string;
    // Add other user properties as needed
}

interface AuthProps {
    user?: User;
    tenant?: {
        id: string;
        config: TenantConfig;
    };
}

export default function AppLayout({ children, title = 'CannaRewards' }: AppLayoutProps) {
    const { props } = usePage<{ auth?: AuthProps }>();

    useEffect(() => {
        document.title = title;
    }, [title]);

    useEffect(() => {
        if (props.auth?.tenant?.config?.theme) {
            const theme = props.auth.tenant.config.theme;

            // Apply theme variables to the root element
            const root = document.documentElement;

            if (theme.primary_color) {
                root.style.setProperty('--primary', theme.primary_color);
            }

            if (theme.font_family) {
                root.style.setProperty('--font-family', theme.font_family);
            }

            if (theme.radius) {
                root.style.setProperty('--radius', theme.radius);
            }
        }
    }, [props.auth?.tenant?.config?.theme]);

    return (
        <div
            className="min-h-screen bg-background"
            style={{
                // Fallback values if CSS variables aren't set yet
                '--primary': props.auth?.tenant?.config?.theme?.primary_color || '#C6A355',
                '--font-family': props.auth?.tenant?.config?.theme?.font_family || 'Inter',
                '--radius': props.auth?.tenant?.config?.theme?.radius || '0.5rem',
            } as React.CSSProperties}
        >
            {/* Fixed Bottom Navigation Bar - The Persistent Shell */}
            <div className="fixed inset-x-0 bottom-0 z-50 border-t bg-background">
                <div className="flex justify-around items-center py-2">
                    <a href="/" className="flex flex-col items-center px-4 py-2 text-sm">
                        <span>Home</span>
                    </a>
                    <a href="/wallet" className="flex flex-col items-center px-4 py-2 text-sm">
                        <span>Wallet</span>
                    </a>
                    <a href="/scan" className="flex flex-col items-center px-4 py-2 text-sm">
                        <span>Scan</span>
                    </a>
                    <a href="/profile" className="flex flex-col items-center px-4 py-2 text-sm">
                        <span>Profile</span>
                    </a>
                </div>
            </div>

            {/* Main Content Area */}
            <main className="pb-16"> {/* Add padding to account for fixed bottom nav */}
                {children}
            </main>
        </div>
    );
}
</file>

<file path="resources/js/lib/utils.ts">
import { clsx, type ClassValue } from "clsx"
import { twMerge } from "tailwind-merge"

export function cn(...inputs: ClassValue[]) {
  return twMerge(clsx(inputs))
}
</file>

<file path="resources/js/Pages/Scan/Error.tsx">
import { Head } from '@inertiajs/react';
import { Button } from '@/Components/ui/button';
import { Link } from '@inertiajs/react';

interface ErrorProps {
    reason: string;
}

export default function Error({ reason }: ErrorProps) {
    let errorMessage = '';
    let errorTitle = '';

    switch (reason) {
        case 'used':
            errorTitle = 'Code Already Used';
            errorMessage = 'This QR code has already been claimed. Each code can only be used once.';
            break;
        case 'invalid':
        default:
            errorTitle = 'Invalid Code';
            errorMessage = 'The QR code you scanned is invalid or has been deactivated.';
            break;
    }

    return (
        <div className="min-h-screen bg-gray-50 flex flex-col">
            <Head title={errorTitle} />
            
            <div className="flex-grow flex flex-col items-center justify-center p-4">
                <div className="max-w-md w-full space-y-6 text-center">
                    <div className="bg-red-100 text-red-800 p-4 rounded-lg">
                        <h1 className="text-2xl font-bold">{errorTitle}</h1>
                    </div>
                    
                    <p className="text-gray-600">{errorMessage}</p>
                    
                    <div className="mt-8">
                        <Link href="/">
                            <Button variant="outline" className="w-full">
                                Back to Home
                            </Button>
                        </Link>
                    </div>
                </div>
            </div>
        </div>
    );
}
</file>

<file path="resources/js/Pages/Scan/Teaser.tsx">
import { Head } from '@inertiajs/react';
import { Button } from '@/Components/ui/button';
import { Link } from '@inertiajs/react';

interface Product {
    id: number;
    sku: string;
    name: string;
    points_awarded: number;
    msrp_cents: number;
    strain_type: string;
    image_url: string;
    is_active: boolean;
}

interface TeaserProps {
    product: Product;
}

export default function Teaser({ product }: TeaserProps) {
    return (
        <div className="min-h-screen bg-gray-50 flex flex-col">
            <Head title={`Claim ${product.name}`} />
            
            <div className="flex-grow flex flex-col items-center justify-center p-4">
                <div className="max-w-md w-full space-y-6">
                    {/* Product Image */}
                    {product.image_url && (
                        <div className="rounded-xl overflow-hidden shadow-lg">
                            <img 
                                src={product.image_url} 
                                alt={product.name} 
                                className="w-full h-64 object-cover"
                            />
                        </div>
                    )}
                    
                    {/* Product Info */}
                    <div className="text-center">
                        <h1 className="text-2xl font-bold text-gray-900">{product.name}</h1>
                        <p className="text-gray-600 mt-2">Strain: {product.strain_type}</p>
                        
                        {/* Points Display */}
                        <div className="mt-4 p-4 bg-gradient-to-r from-yellow-400 to-yellow-500 rounded-lg">
                            <p className="text-white text-lg font-semibold">+{product.points_awarded} Points</p>
                        </div>
                        
                        <p className="text-gray-500 text-sm mt-2">
                            MSRP: ${(product.msrp_cents / 100).toFixed(2)}
                        </p>
                    </div>
                    
                    {/* Claim Button */}
                    <div className="mt-8">
                        <Link href={`/auth/login?code=${product.sku}`}>
                            <Button className="w-full py-6 text-lg">
                                Claim Points
                            </Button>
                        </Link>
                    </div>
                </div>
            </div>
        </div>
    );
}
</file>

<file path="resources/js/types/generated.d.ts">
declare namespace App.Data {
export type TestDTO = {
name: string;
age: number;
isActive: boolean;
};
}
declare namespace App.Data.Tenant {
export type CommercialGoodData = {
id: number;
sku: string;
name: string;
description: string | null;
points_awarded: number;
image_url: string;
is_active: boolean;
};
}
</file>

<file path="resources/js/app.js">
import './bootstrap';
</file>

<file path="resources/js/app.tsx">
import './bootstrap';
import React from 'react';
import { createRoot } from 'react-dom/client';
import { createInertiaApp } from '@inertiajs/react';
import { resolvePageComponent } from 'laravel-vite-plugin/inertia-helpers';

const appName = import.meta.env.VITE_APP_NAME || 'Laravel';

createInertiaApp({
    title: (title) => `${title} - ${appName}`,
    resolve: (name) => resolvePageComponent(`./Pages/${name}.tsx`, import.meta.glob('./Pages/**/*.tsx')),
    setup({ el, App, props }) {
        const root = createRoot(el);

        // Ziggy's route function should be available globally via the @routes directive in the Blade template
        // If not available globally, we'll import it from the ziggy-js package
        if (typeof window.route === 'undefined') {
            // Dynamically import ziggy-js if not available globally
            import('ziggy-js').then(({ route: ziggyRoute }) => {
                // Get Ziggy configuration from the global object (set by @routes directive)
                const ziggyConfig = typeof window.Ziggy !== 'undefined' ? window.Ziggy : undefined;

                // Make the route function available globally
                window.route = (...args) => ziggyRoute(...args, ziggyConfig);
            });
        }

        return root.render(<App {...props} />);
    },
    progress: {
        color: '#4F46E5',
    },
});
</file>

<file path="resources/js/bootstrap.js">
/* global window */

import axios from 'axios';

window.axios = axios;

window.axios.defaults.headers.common['X-Requested-With'] = 'XMLHttpRequest';
</file>

<file path="routes/console.php">
<?php

use Illuminate\Foundation\Inspiring;
use Illuminate\Support\Facades\Artisan;

Artisan::command('inspire', function () {
    $this->comment(Inspiring::quote());
})->purpose('Display an inspiring quote');
</file>

<file path="routes/tenant.php">
<?php

declare(strict_types=1);

use App\Http\Controllers\Scan\TeaserController;
use Illuminate\Support\Facades\Route;
use Stancl\Tenancy\Middleware\InitializeTenancyByDomain;
/*
|--------------------------------------------------------------------------
| Tenant Routes
|--------------------------------------------------------------------------
|
| Here you can register the tenant routes for your application.
| These routes are loaded by the TenantRouteServiceProvider.
|
| Feel free to customize them however you want. Good luck!
|
*/

use Stancl\Tenancy\Middleware\PreventAccessFromCentralDomains;

Route::middleware([
    'web',
    InitializeTenancyByDomain::class,
    PreventAccessFromCentralDomains::class,
])->group(function () {
    Route::get('/', function () {
        return 'This is your multi-tenant application. The id of the current tenant is '.tenant('id');
    });

    Route::get('/tenant-test', function () {
        return 'I am a Tenant';
    });

    // The Soft Trap - Teaser Page
    Route::get('/claim/{code}', TeaserController::class)->name('scan.teaser');
});
</file>

<file path="routes/web.php">
<?php

use Illuminate\Support\Facades\Route;

Route::get('/', function () {
    // Redirect to admin panel for central domain
    return redirect()->route('filament.admin.pages.dashboard');
});

Route::get('/central-test', function () {
    return 'I am Central';
});
</file>

<file path="tests/Feature/Tenant/GenerateQrBatchTest.php">
<?php

namespace Tests\Feature\Tenant;

use App\Actions\Tenant\GenerateQrBatchAction;
use App\Models\Tenant as TenantModel;
use App\Models\Tenant\CommercialGood;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Facades\Storage;
use PHPUnit\Framework\Attributes\Test;
use Tests\TestCase;

class GenerateQrBatchTest extends TestCase
{
    #[Test]
    public function it_generates_batch_and_uploads_csv()
    {
        // Setup: Initialize a Tenant ('dime')
        $tenant = TenantModel::find('dime');
        if (! $tenant) {
            $tenant = TenantModel::create([
                'id' => 'dime',
                'brand_name' => 'Dime Industries',
                'plan' => 'enterprise',
            ]);
        }

        // Create the tenant database if it doesn't exist
        $tenantDatabaseName = 'tenant'.$tenant->getTenantKey();
        $existingDatabase = DB::connection('mysql')->select('SELECT SCHEMA_NAME FROM INFORMATION_SCHEMA.SCHEMATA WHERE SCHEMA_NAME = ?', [$tenantDatabaseName]);

        if (empty($existingDatabase)) {
            DB::connection('mysql')->statement("CREATE DATABASE IF NOT EXISTS `{$tenantDatabaseName}`");
        }

        Storage::fake('s3');

        // CRITICAL FIX: Force the config to set the tenant database
        config(['database.connections.tenant.database' => $tenantDatabaseName]);
        DB::purge('tenant');
        DB::reconnect('tenant');

        // Run tenant migrations to ensure tables exist
        \Illuminate\Support\Facades\Artisan::call('migrate', [
            '--path' => 'database/migrations/tenant',
            '--database' => 'tenant',
            '--force' => true,
        ]);

        // Create a CommercialGood inside that tenant
        $commercialGood = null;
        $tenant->run(function () use (&$commercialGood) {
            $commercialGood = CommercialGood::create([
                'sku' => 'TEST-SKU-'.uniqid(),
                'name' => 'Test Product',
                'points_awarded' => 100,
                'msrp_cents' => 2000,
                'strain_type' => 'sativa',
            ]);
        });

        // Test Case: Run inside $tenant->run(function() { ... })
        $csvPath = null;
        $batchLabel = 'Test Batch';
        $tenant->run(function () use ($commercialGood, &$csvPath, $batchLabel) {
            // Clear any existing codes with this batch label
            \App\Models\Tenant\RewardCode::where('batch_id', $batchLabel)->delete();

            // Call (new GenerateQrBatchAction)->execute($product, 50, 'Test Batch')
            $action = new GenerateQrBatchAction;
            $csvPath = $action->execute($commercialGood, 50, $batchLabel);
        });

        // Assertions:
        // Assert reward_codes table count is 50
        $codeCount = 0;
        $tenant->run(function () use (&$codeCount, $batchLabel) {
            // Count only the codes created in this specific batch
            $codeCount = \App\Models\Tenant\RewardCode::where('batch_id', $batchLabel)->count();
        });
        $this->assertEquals(50, $codeCount);

        // Assert Storage::disk('s3')->exists(...) is true
        Storage::disk('s3')->assertExists($csvPath);

        // Assert the CSV content contains 50 rows (plus header)
        $csvContent = Storage::disk('s3')->get($csvPath);
        $rows = explode("\n", trim($csvContent));
        // Should have 51 rows: 1 header + 50 data rows
        $this->assertCount(51, $rows);
    }
}
</file>

<file path="tests/Feature/Tenant/TeaserTest.php">
<?php

namespace Tests\Feature\Tenant;

use App\Models\Tenant;
use App\Models\Tenant\CommercialGood;
use App\Models\Tenant\RewardCode;
use Illuminate\Support\Facades\Route;
use Illuminate\Support\ServiceProvider;
use PHPUnit\Framework\Attributes\Test;
use Stancl\Tenancy\Concerns\TenantAware;
use Tests\TestCaseTenant;
use Tests\Traits\SetUpTenantTest;

class TeaserTest extends TestCaseTenant
{
    use SetUpTenantTest;

    protected function setUp(): void
    {
        parent::setUp();

        // Set up the tenant once for all tests in this class
        $this->setUpTenant('dime', 'dime.localhost');
    }

    protected function tearDown(): void
    {
        $this->tearDownTenant('dime');
        parent::tearDown();
    }

    #[Test]
    public function guest_can_see_teaser_page_for_active_code()
    {
        // Get the tenant
        $tenant = Tenant::find('dime');

        // Create a CommercialGood inside that tenant
        $commercialGood = null;
        $tenant->run(function () use (&$commercialGood) {
            $commercialGood = CommercialGood::create([
                'sku' => 'TEST-SKU-'.uniqid(),
                'name' => 'Test Product',
                'points_awarded' => 100,
                'msrp_cents' => 2000,
                'strain_type' => 'sativa',
                'image_url' => 'https://example.com/test-image.jpg',
            ]);
        });

        // Create an active reward code
        $rewardCode = null;
        $tenant->run(function () use ($commercialGood, &$rewardCode) {
            $rewardCode = RewardCode::create([
                'code' => str_pad('TC'.substr(md5(uniqid()), 0, 14), 16, '0'),
                'commercial_good_id' => $commercialGood->id,
                'batch_id' => 'BATCH-'.substr(md5(uniqid()), 0, 8),
                'status' => 'active',
            ]);
        });

        // Bypass the domain identification middleware and directly initialize tenancy
        tenancy()->initialize($tenant);

        $response = $this->withoutMiddleware([\Stancl\Tenancy\Middleware\InitializeTenancyByDomain::class])
            ->withHeader('HOST', 'dime.localhost')
            ->get("/claim/{$rewardCode->code}");

        $response->assertOk();
        $response->assertInertia(fn ($page) => $page
            ->component('Scan/Teaser')
            ->has('product')
            ->where('product.name', $commercialGood->name)
            ->where('product.points_awarded', $commercialGood->points_awarded)
        );
    }

    #[Test]
    public function guest_sees_error_page_for_used_code()
    {
        // Get the tenant
        $tenant = Tenant::find('dime');

        // Create a CommercialGood inside that tenant for foreign key constraint
        $commercialGood = null;
        $tenant->run(function () use (&$commercialGood) {
            $commercialGood = CommercialGood::create([
                'sku' => 'TEST-SKU-'.uniqid(),
                'name' => 'Test Product for Used Code',
                'points_awarded' => 100,
                'msrp_cents' => 2000,
                'strain_type' => 'sativa',
                'image_url' => 'https://example.com/test-image.jpg',
            ]);
        });

        // Create a used reward code
        $rewardCode = null;
        $tenant->run(function () use ($commercialGood, &$rewardCode) {
            $rewardCode = RewardCode::create([
                'code' => str_pad('UC'.substr(md5(uniqid()), 0, 14), 16, '0'),
                'commercial_good_id' => $commercialGood->id, // Use the actual ID
                'batch_id' => 'BATCH-'.substr(md5(uniqid()), 0, 8),
                'status' => 'used',
            ]);
        });

        // Bypass the domain identification middleware and directly initialize tenancy
        tenancy()->initialize($tenant);

        $response = $this->withoutMiddleware([\Stancl\Tenancy\Middleware\InitializeTenancyByDomain::class])
            ->withHeader('HOST', 'dime.localhost')
            ->get("/claim/{$rewardCode->code}");

        $response->assertOk();
        $response->assertInertia(fn ($page) => $page
            ->component('Scan/Error')
            ->where('reason', 'used')
        );
    }

    #[Test]
    public function guest_sees_error_page_for_void_code()
    {
        // Get the tenant
        $tenant = Tenant::find('dime');

        // Create a CommercialGood inside that tenant for foreign key constraint
        $commercialGood = null;
        $tenant->run(function () use (&$commercialGood) {
            $commercialGood = CommercialGood::create([
                'sku' => 'TEST-SKU-'.uniqid(),
                'name' => 'Test Product for Void Code',
                'points_awarded' => 100,
                'msrp_cents' => 2000,
                'strain_type' => 'sativa',
                'image_url' => 'https://example.com/test-image.jpg',
            ]);
        });

        // Create a void reward code
        $rewardCode = null;
        $tenant->run(function () use ($commercialGood, &$rewardCode) {
            $rewardCode = RewardCode::create([
                'code' => str_pad('VC'.substr(md5(uniqid()), 0, 14), 16, '0'),
                'commercial_good_id' => $commercialGood->id, // Use the actual ID
                'batch_id' => 'BATCH-'.substr(md5(uniqid()), 0, 8),
                'status' => 'void',
            ]);
        });

        // Bypass the domain identification middleware and directly initialize tenancy
        tenancy()->initialize($tenant);

        $response = $this->withoutMiddleware([\Stancl\Tenancy\Middleware\InitializeTenancyByDomain::class])
            ->withHeader('HOST', 'dime.localhost')
            ->get("/claim/{$rewardCode->code}");

        $response->assertOk();
        $response->assertInertia(fn ($page) => $page
            ->component('Scan/Error')
            ->where('reason', 'invalid')
        );
    }

    #[Test]
    public function guest_sees_error_page_for_nonexistent_code()
    {
        // Bypass the domain identification middleware and directly initialize tenancy
        $tenant = Tenant::find('dime');
        tenancy()->initialize($tenant);

        $response = $this->withoutMiddleware([\Stancl\Tenancy\Middleware\InitializeTenancyByDomain::class])
            ->withHeader('HOST', 'dime.localhost')
            ->get('/claim/NONEXISTENT-CODE');

        $response->assertOk();
        $response->assertInertia(fn ($page) => $page
            ->component('Scan/Error')
            ->where('reason', 'invalid')
        );
    }
}
</file>

<file path="tests/Feature/ExampleTest.php">
<?php

namespace Tests\Feature;

// use Illuminate\Foundation\Testing\RefreshDatabase;
use PHPUnit\Framework\Attributes\Test;
use Tests\TestCase;

class ExampleTest extends TestCase
{
    #[Test]
    public function test_the_application_redirects_to_admin_dashboard(): void
    {
        $response = $this->get('/');

        $response->assertRedirect(route('filament.admin.pages.dashboard'));
    }
}
</file>

<file path="tests/Traits/SetUpTenantTest.php">
<?php

namespace Tests\Traits;

use App\Models\Tenant;
use Illuminate\Support\Facades\DB;
use Stancl\Tenancy\Database\Models\Domain;

trait SetUpTenantTest
{
    protected function setUpTenant(string $tenantId = 'dime', string $domain = 'dime.localhost'): Tenant
    {
        // Create or get the tenant
        $tenant = Tenant::find($tenantId);
        if (!$tenant) {
            $tenant = Tenant::create([
                'id' => $tenantId,
                'brand_name' => ucfirst($tenantId) . ' Industries',
                'plan' => 'enterprise',
            ]);
        }

        // Create or update domain record for the tenant in the central database
        // Use the central connection to create the domain record
        $originalConnection = DB::getDefaultConnection();
        DB::setDefaultConnection('central');

        \Stancl\Tenancy\Database\Models\Domain::updateOrCreate([
            'domain' => $domain,
        ], [
            'tenant_id' => $tenantId,
        ]);

        // Switch back to original connection
        DB::setDefaultConnection($originalConnection);

        // Create the tenant database if it doesn't exist
        $tenantDatabaseName = 'tenant' . $tenant->getTenantKey();
        DB::connection('mysql')->statement("CREATE DATABASE IF NOT EXISTS `{$tenantDatabaseName}`");

        // Force the config to set the tenant database
        config(['database.connections.tenant.database' => $tenantDatabaseName]);
        DB::purge('tenant');
        DB::reconnect('tenant');

        // Run tenant migrations to ensure tables exist
        $this->artisan('migrate', [
            '--path' => 'database/migrations/tenant',
            '--database' => 'tenant',
            '--force' => true,
        ]);

        return $tenant;
    }

    protected function tearDownTenant(string $tenantId = 'dime'): void
    {
        $tenantDatabaseName = 'tenant' . $tenantId;
        try {
            DB::connection('mysql')->statement("DROP DATABASE IF EXISTS `{$tenantDatabaseName}`");
        } catch (\Exception $e) {
            // Ignore errors during cleanup
        }
    }
}
</file>

<file path="tests/Unit/Tenant/CommercialGoodTest.php">
<?php

namespace Tests\Unit\Tenant;

use App\Models\Tenant;
use App\Models\Tenant\CommercialGood;
use PHPUnit\Framework\Attributes\Test;
use Tests\TestCase;

class CommercialGoodTest extends TestCase
{
    #[Test]
    public function test_commercial_good_can_be_created_in_tenant_context()
    {
        // Cleanup from previous runs (necessary because createDatabase causes implicit commit)
        if ($t = Tenant::find('test_tenant')) {
            $t->delete();
        }
        \Illuminate\Support\Facades\DB::connection('mysql')->statement('DROP DATABASE IF EXISTS tenanttest_tenant');

        $tenant = Tenant::create([
            'id' => 'test_tenant',
            'brand_name' => 'Test Brand',
            'plan' => 'starter',
        ]);

        // Manual trigger since event isn't firing in test env
        // This causes implicit commit!
        $tenant->database()->manager()->createDatabase($tenant);

        tenancy()->initialize($tenant);

        // Manual override for TenantConnection trait
        config(['database.connections.tenant.database' => $tenant->database()->getName()]);
        \Illuminate\Support\Facades\DB::purge('tenant');

        // Run migrations on the tenant connection
        \Illuminate\Support\Facades\Artisan::call('migrate', [
            '--path' => 'database/migrations/tenant',
            '--database' => 'tenant', // Explicitly migrate the tenant connection
            '--force' => true,
        ]);

        $good = CommercialGood::create([
            'sku' => 'TEST-SKU-001',
            'name' => 'Test Product',
            'points_awarded' => 100,
            'msrp_cents' => 2000,
            'strain_type' => 'sativa',
            'is_active' => true,
        ]);

        $this->assertDatabaseHas('commercial_goods', [
            'sku' => 'TEST-SKU-001',
        ], 'tenant');

        // Verify RewardCode relationship
        $code = \App\Models\Tenant\RewardCode::create([
            'code' => 'TEST-Reward-123',
            'commercial_good_id' => $good->id,
            'batch_id' => 'BATCH-001',
            'status' => 'active',
        ]);

        // dump($code->toArray());

        $this->assertDatabaseHas('reward_codes', [
            'code' => 'TEST-Reward-123',
            'commercial_good_id' => $good->id,
        ], 'tenant');

        $codeWithRelationship = \App\Models\Tenant\RewardCode::with('commercialGood')->find($code->code);
        $this->assertEquals($good->id, $codeWithRelationship->commercialGood->getAttribute('id'));
    }
}
</file>

<file path="tests/Unit/Tenant/GenerateQrBatchActionTest.php">
<?php

namespace Tests\Unit\Tenant;

use App\Actions\Tenant\GenerateQrBatchAction;
use App\Models\Tenant;
use App\Models\Tenant\CommercialGood;
use App\Models\Tenant\RewardCode;
use Illuminate\Foundation\Testing\RefreshDatabase;
use Illuminate\Support\Facades\Storage;
use PHPUnit\Framework\Attributes\Test;
use Tests\TestCase;

class GenerateQrBatchActionTest extends TestCase
{
    #[Test]
    public function test_it_generates_codes_and_uploads_csv()
    {
        // 1. Setup Tenant (using the fix from previous task)
        $tenantId = 'test_qr_tenant';

        // Cleanup
        if ($t = Tenant::find($tenantId)) {
            $t->delete();
        }
        \Illuminate\Support\Facades\DB::connection('mysql')->statement("DROP DATABASE IF EXISTS tenant{$tenantId}");

        $tenant = Tenant::create([
            'id' => $tenantId,
            'brand_name' => 'QR Brand',
            'plan' => 'growth',
        ]);

        $tenant->database()->manager()->createDatabase($tenant);
        tenancy()->initialize($tenant);

        // FIX: Manual override for TenantConnection trait in test environment
        config(['database.connections.tenant.database' => $tenant->database()->getName()]);
        \Illuminate\Support\Facades\DB::purge('tenant');

        \Illuminate\Support\Facades\Artisan::call('migrate', [
            '--path' => 'database/migrations/tenant',
            '--database' => 'tenant',
            '--force' => true,
        ]);

        // 2. Setup Data
        $good = CommercialGood::create([
            'sku' => 'QR-TEST-GOOD',
            'name' => 'QR Test Good',
            'points_awarded' => 100,
            'msrp_cents' => 1000,
            'strain_type' => 'hybrid',
            'is_active' => true,
        ]);

        Storage::fake('s3');

        // 3. Execute Action
        $action = new GenerateQrBatchAction;
        $batchLabel = 'BATCH-TEST-001';
        $quantity = 50;

        $filePath = $action->execute($good, $quantity, $batchLabel);

        // 4. Verification

        // DB Assertion
        $this->assertEquals($quantity, RewardCode::where('batch_id', $batchLabel)->count());
        $this->assertDatabaseHas('reward_codes', [
            'batch_id' => $batchLabel,
            'commercial_good_id' => $good->id,
        ], 'tenant');

        // Storage Assertion
        Storage::disk('s3')->assertExists($filePath);

        // Content Assertion
        $content = Storage::disk('s3')->get($filePath);
        $this->assertStringContainsString('code,url', $content); // Header

        // Check a random code exists in CSV
        $randomCode = RewardCode::first()->code;
        $this->assertStringContainsString($randomCode, $content);

        // Cleanup (Automated by RefreshDatabase mostly, but good practice for tenant DBs)
    }
}
</file>

<file path="tests/Unit/ExampleTest.php">
<?php

namespace Tests\Unit;

use PHPUnit\Framework\TestCase;

class ExampleTest extends TestCase
{
    /**
     * A basic test example.
     */
    public function test_that_basic_math_works(): void
    {
        $this->assertEquals(2, 1 + 1);
    }
}
</file>

<file path="tests/TestCase.php">
<?php

namespace Tests;

use Illuminate\Foundation\Testing\TestCase as BaseTestCase;

abstract class TestCase extends BaseTestCase
{
    //
}
</file>

<file path="tests/TestCaseTenant.php">
<?php

namespace Tests;

use Illuminate\Support\Facades\Route;

class TestCaseTenant extends TestCase
{
    protected function setUp(): void
    {
        parent::setUp();
        
        // Ensure tenant routes are loaded
        $this->loadTenantRoutes();
    }
    
    protected function loadTenantRoutes(): void
    {
        // Load tenant routes for testing
        if (file_exists(base_path('routes/tenant.php'))) {
            // Load the tenant routes with the web middleware only for testing
            Route::middleware(['web'])->group(base_path('routes/tenant.php'));
        }
    }
}
</file>

<file path=".env.example">
APP_NAME=Laravel
APP_ENV=local
APP_KEY=
APP_DEBUG=true
APP_URL=http://localhost

APP_LOCALE=en
APP_FALLBACK_LOCALE=en
APP_FAKER_LOCALE=en_US

APP_MAINTENANCE_DRIVER=file
# APP_MAINTENANCE_STORE=database

# PHP_CLI_SERVER_WORKERS=4

BCRYPT_ROUNDS=12

LOG_CHANNEL=stack
LOG_STACK=single
LOG_DEPRECATIONS_CHANNEL=null
LOG_LEVEL=debug

DB_CONNECTION=sqlite
# DB_HOST=127.0.0.1
# DB_PORT=3306
# DB_DATABASE=laravel
# DB_USERNAME=root
# DB_PASSWORD=

SESSION_DRIVER=database
SESSION_LIFETIME=120
SESSION_ENCRYPT=false
SESSION_PATH=/
SESSION_DOMAIN=null

BROADCAST_CONNECTION=log
FILESYSTEM_DISK=local
QUEUE_CONNECTION=database

CACHE_STORE=database
# CACHE_PREFIX=

MEMCACHED_HOST=127.0.0.1

REDIS_CLIENT=phpredis
REDIS_HOST=127.0.0.1
REDIS_PASSWORD=null
REDIS_PORT=6379

MAIL_MAILER=log
MAIL_SCHEME=null
MAIL_HOST=127.0.0.1
MAIL_PORT=2525
MAIL_USERNAME=null
MAIL_PASSWORD=null
MAIL_FROM_ADDRESS="hello@example.com"
MAIL_FROM_NAME="${APP_NAME}"

AWS_ACCESS_KEY_ID=
AWS_SECRET_ACCESS_KEY=
AWS_DEFAULT_REGION=us-east-1
AWS_BUCKET=
AWS_USE_PATH_STYLE_ENDPOINT=false

VITE_APP_NAME="${APP_NAME}"
</file>

<file path="artisan">
#!/usr/bin/env php
<?php

use Illuminate\Foundation\Application;
use Symfony\Component\Console\Input\ArgvInput;

define('LARAVEL_START', microtime(true));

// Register the Composer autoloader...
require __DIR__.'/vendor/autoload.php';

// Bootstrap Laravel and handle the command...
/** @var Application $app */
$app = require_once __DIR__.'/bootstrap/app.php';

$status = $app->handleCommand(new ArgvInput);

exit($status);
</file>

<file path="composer.json">
{
    "$schema": "https://getcomposer.org/schema.json",
    "name": "laravel/laravel",
    "type": "project",
    "description": "The skeleton application for the Laravel framework.",
    "keywords": ["laravel", "framework"],
    "license": "MIT",
    "require": {
        "php": "^8.3",
        "filament/filament": "^3.2",
        "inertiajs/inertia-laravel": "^2.0",
        "laravel/framework": "^12.0",
        "laravel/tinker": "^2.10.1",
        "league/csv": "^9.28",
        "spatie/laravel-data": "^4.18",
        "stancl/tenancy": "^3.9",
        "tightenco/ziggy": "^2.6",
        "symfony/string": "^7.0",
        "symfony/translation": "^7.0",
        "symfony/event-dispatcher": "^7.0",
        "symfony/css-selector": "^7.0",
        "symfony/clock": "^7.0"
    },
    "require-dev": {
        "fakerphp/faker": "^1.23",
        "larastan/larastan": "^3.8",
        "laravel/pail": "^1.2.2",
        "laravel/pint": "^1.27",
        "laravel/sail": "^1.41",
        "mockery/mockery": "^1.6",
        "nunomaduro/collision": "^8.6",
        "phpunit/phpunit": "^11.5.3",
        "spatie/laravel-typescript-transformer": "^2.5"
    },
    "autoload": {
        "psr-4": {
            "App\\": "app/",
            "Database\\Factories\\": "database/factories/",
            "Database\\Seeders\\": "database/seeders/"
        }
    },
    "autoload-dev": {
        "psr-4": {
            "Tests\\": "tests/"
        }
    },
    "scripts": {
        "setup": [
            "composer install",
            "@php -r \"file_exists('.env') || copy('.env.example', '.env');\"",
            "@php artisan key:generate",
            "@php artisan migrate --force",
            "npm install",
            "npm run build"
        ],
        "dev": [
            "Composer\\Config::disableProcessTimeout",
            "npx concurrently -c \"#93c5fd,#c4b5fd,#fb7185,#fdba74\" \"php artisan serve\" \"php artisan queue:listen --tries=1\" \"php artisan pail --timeout=0\" \"npm run dev\" --names=server,queue,logs,vite --kill-others"
        ],
        "test": [
            "@php artisan config:clear --ansi",
            "@php artisan test"
        ],
        "post-autoload-dump": [
            "Illuminate\\Foundation\\ComposerScripts::postAutoloadDump",
            "@php artisan package:discover --ansi",
            "@php artisan filament:upgrade"
        ],
        "post-update-cmd": [
            "@php artisan vendor:publish --tag=laravel-assets --ansi --force"
        ],
        "post-root-package-install": [
            "@php -r \"file_exists('.env') || copy('.env.example', '.env');\""
        ],
        "post-create-project-cmd": [
            "@php artisan key:generate --ansi",
            "@php -r \"file_exists('database/database.sqlite') || touch('database/database.sqlite');\"",
            "@php artisan migrate --graceful --ansi"
        ],
        "pre-package-uninstall": [
            "Illuminate\\Foundation\\ComposerScripts::prePackageUninstall"
        ]
    },
    "extra": {
        "laravel": {
            "dont-discover": []
        }
    },
    "config": {
        "optimize-autoloader": true,
        "preferred-install": "dist",
        "sort-packages": true,
        "allow-plugins": {
            "pestphp/pest-plugin": true,
            "php-http/discovery": true
        }
    },
    "minimum-stability": "stable",
    "prefer-stable": true
}
</file>

<file path="eslint.config.js">
// @ts-check

import js from '@eslint/js';
import reactHooks from 'eslint-plugin-react-hooks';
import reactRefresh from 'eslint-plugin-react-refresh';
import tseslint from 'typescript-eslint';

export default tseslint.config(
  { ignores: ['dist', 'node_modules', 'public', 'storage', 'vendor'] },
  {
    files: ['**/*.{js,jsx}'],
    extends: [js.configs.recommended],
    languageOptions: {
      ecmaVersion: 2020,
      sourceType: 'module',
    },
    plugins: {
      'react-hooks': reactHooks,
      'react-refresh': reactRefresh,
    },
    rules: {
      ...reactHooks.configs.recommended.rules,
      'react-refresh/only-export-components': [
        'warn',
        { allowConstantExport: true },
      ],
    },
  },
  {
    files: ['**/*.{ts,tsx}'],
    extends: [js.configs.recommended, ...tseslint.configs.recommended],
    languageOptions: {
      ecmaVersion: 2020,
      sourceType: 'module',
      parser: tseslint.parser,
      parserOptions: {
        project: ['./tsconfig.json'], // Specify the path to your project's tsconfig.json
        tsconfigRootDir: import.meta.dirname,
      },
    },
    plugins: {
      'react-hooks': reactHooks,
      'react-refresh': reactRefresh,
    },
    rules: {
      ...reactHooks.configs.recommended.rules,
      'react-refresh/only-export-components': [
        'warn',
        { allowConstantExport: true },
      ],
    },
  }
);
</file>

<file path="package.json">
{
    "$schema": "https://www.schemastore.org/package.json",
    "private": true,
    "type": "module",
    "scripts": {
        "build": "vite build",
        "dev": "vite",
        "lint": "eslint resources/js --ext .js,.jsx,.ts,.tsx --fix"
    },
    "devDependencies": {
        "@eslint/js": "^9.39.2",
        "@tailwindcss/vite": "^4.0.0",
        "axios": "^1.11.0",
        "concurrently": "^9.0.1",
        "eslint": "^9.39.2",
        "eslint-plugin-react-hooks": "^7.0.1",
        "eslint-plugin-react-refresh": "^0.4.26",
        "laravel-vite-plugin": "^2.0.0",
        "tailwindcss": "^4.1.18",
        "tw-animate-css": "^1.4.0",
        "typescript-eslint": "^8.53.0",
        "vite": "^7.0.7"
    },
    "dependencies": {
        "@inertiajs/react": "^2.3.7",
        "@radix-ui/react-label": "^2.1.8",
        "@radix-ui/react-slot": "^1.2.4",
        "@vitejs/plugin-react": "^5.1.2",
        "autoprefixer": "^10.4.23",
        "class-variance-authority": "^0.7.1",
        "clsx": "^2.1.1",
        "framer-motion": "^12.24.12",
        "lucide-react": "^0.562.0",
        "next-themes": "^0.4.6",
        "postcss": "^8.5.6",
        "react": "^19.2.3",
        "react-dom": "^19.2.3",
        "sonner": "^2.0.7",
        "tailwind-merge": "^3.4.0",
        "ziggy-js": "^2.6.0"
    }
}
</file>

<file path="README.md">
<p align="center"><a href="https://laravel.com" target="_blank"><img src="https://raw.githubusercontent.com/laravel/art/master/logo-lockup/5%20SVG/2%20CMYK/1%20Full%20Color/laravel-logolockup-cmyk-red.svg" width="400" alt="Laravel Logo"></a></p>

<p align="center">
<a href="https://github.com/laravel/framework/actions"><img src="https://github.com/laravel/framework/workflows/tests/badge.svg" alt="Build Status"></a>
<a href="https://packagist.org/packages/laravel/framework"><img src="https://img.shields.io/packagist/dt/laravel/framework" alt="Total Downloads"></a>
<a href="https://packagist.org/packages/laravel/framework"><img src="https://img.shields.io/packagist/v/laravel/framework" alt="Latest Stable Version"></a>
<a href="https://packagist.org/packages/laravel/framework"><img src="https://img.shields.io/packagist/l/laravel/framework" alt="License"></a>
</p>

## About Laravel

Laravel is a web application framework with expressive, elegant syntax. We believe development must be an enjoyable and creative experience to be truly fulfilling. Laravel takes the pain out of development by easing common tasks used in many web projects, such as:

- [Simple, fast routing engine](https://laravel.com/docs/routing).
- [Powerful dependency injection container](https://laravel.com/docs/container).
- Multiple back-ends for [session](https://laravel.com/docs/session) and [cache](https://laravel.com/docs/cache) storage.
- Expressive, intuitive [database ORM](https://laravel.com/docs/eloquent).
- Database agnostic [schema migrations](https://laravel.com/docs/migrations).
- [Robust background job processing](https://laravel.com/docs/queues).
- [Real-time event broadcasting](https://laravel.com/docs/broadcasting).

Laravel is accessible, powerful, and provides tools required for large, robust applications.

## Learning Laravel

Laravel has the most extensive and thorough [documentation](https://laravel.com/docs) and video tutorial library of all modern web application frameworks, making it a breeze to get started with the framework. You can also check out [Laravel Learn](https://laravel.com/learn), where you will be guided through building a modern Laravel application.

If you don't feel like reading, [Laracasts](https://laracasts.com) can help. Laracasts contains thousands of video tutorials on a range of topics including Laravel, modern PHP, unit testing, and JavaScript. Boost your skills by digging into our comprehensive video library.

## Laravel Sponsors

We would like to extend our thanks to the following sponsors for funding Laravel development. If you are interested in becoming a sponsor, please visit the [Laravel Partners program](https://partners.laravel.com).

### Premium Partners

- **[Vehikl](https://vehikl.com)**
- **[Tighten Co.](https://tighten.co)**
- **[Kirschbaum Development Group](https://kirschbaumdevelopment.com)**
- **[64 Robots](https://64robots.com)**
- **[Curotec](https://www.curotec.com/services/technologies/laravel)**
- **[DevSquad](https://devsquad.com/hire-laravel-developers)**
- **[Redberry](https://redberry.international/laravel-development)**
- **[Active Logic](https://activelogic.com)**

## Contributing

Thank you for considering contributing to the Laravel framework! The contribution guide can be found in the [Laravel documentation](https://laravel.com/docs/contributions).

## Code of Conduct

In order to ensure that the Laravel community is welcoming to all, please review and abide by the [Code of Conduct](https://laravel.com/docs/contributions#code-of-conduct).

## Security Vulnerabilities

If you discover a security vulnerability within Laravel, please send an e-mail to Taylor Otwell via [taylor@laravel.com](mailto:taylor@laravel.com). All security vulnerabilities will be promptly addressed.

## License

The Laravel framework is open-sourced software licensed under the [MIT license](https://opensource.org/licenses/MIT).
</file>

<file path="tsconfig.json">
{
    "compilerOptions": {
        "allowJs": true,
        "module": "ESNext",
        "moduleResolution": "bundler",
        "jsx": "react-jsx",
        "strict": true,
        "esModuleInterop": true,
        "skipLibCheck": true,
        "forceConsistentCasingInFileNames": true,
        "noEmit": true,
        "paths": {
            "@/*": ["./resources/js/*"],
            "@/types/*": ["./resources/js/types/*"]
        }
    },
    "include": [
        "resources/js/**/*.ts",
        "resources/js/**/*.tsx",
        "resources/js/types/**/*",
        "resources/js/types/*.d.ts"
    ],
    "exclude": ["node_modules", "public"]
}
</file>

<file path="vite.config.js">
import { defineConfig } from 'vite';
import laravel from 'laravel-vite-plugin';
import react from '@vitejs/plugin-react';
import tailwindcss from '@tailwindcss/vite';

export default defineConfig({
    plugins: [
        laravel({
            input: ['resources/css/app.css', 'resources/js/app.tsx'],
            refresh: true,
        }),
        react(),
        tailwindcss(),
    ],
    resolve: {
        conditions: ['import', 'browser', 'default'],
    },
    server: {
        host: true,
        watch: {
            ignored: ['**/storage/framework/views/**'],
        },
    },
});
</file>

</files>
